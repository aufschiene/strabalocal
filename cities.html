<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Straba Städte</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      color: #333;
      padding: 20px;
      padding-bottom: 120px;
    }
    
    .container { max-width: 500px; margin: 0 auto; }
    
    .header {
      text-align: center;
      margin-bottom: 24px;
    }
    .header h1 { font-size: 24px; margin-bottom: 8px; color: #333; }
    .header p { color: #666; font-size: 14px; }
    
    /* Breadcrumb */
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      flex-wrap: wrap;
    }
    .breadcrumb-item {
      color: #888;
      cursor: pointer;
      transition: color 0.2s;
    }
    .breadcrumb-item:hover { color: #0055a4; }
    .breadcrumb-item.active { color: #0055a4; font-weight: 600; cursor: default; }
    .breadcrumb-sep { color: #ccc; }
    
    /* Cards */
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .card h2 {
      font-size: 16px;
      color: #333;
      margin-bottom: 16px;
    }
    
    /* Selection Grid */
    .selection-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .selection-grid.single { grid-template-columns: 1fr; }
    
    .selection-btn {
      padding: 16px;
      border-radius: 12px;
      border: 2px solid #e0e0e0;
      background: #fff;
      color: #333;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .selection-btn:hover {
      border-color: #0055a4;
      background: #f0f5fa;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .selection-btn .icon { font-size: 32px; margin-bottom: 8px; }
    .selection-btn .name { font-weight: 600; font-size: 15px; margin-bottom: 4px; color: #333; }
    .selection-btn .desc { font-size: 11px; color: #888; }
    
    /* Network Brand Colors */
    .network-badge {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 14px;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }
    .network-badge.wl { background: #E20613; color: #fff; }
    .network-badge.wlb { background: #1E4D8C; color: #fff; }
    .network-badge.linz { background: #009640; color: #fff; }
    .network-badge.db { background: #EC0016; color: #fff; }
    .network-badge.berlin { background: #F0AB00; color: #000; }
    .network-badge.bodo { background: #005BBB; color: #fff; }
    .network-badge.salzburg { background: #E3000F; color: #fff; }
    
    /* Region badges */
    .region-badge {
      display: inline-block;
      width: 48px;
      height: 32px;
      border-radius: 6px;
      margin-bottom: 10px;
      line-height: 32px;
      font-weight: 700;
      font-size: 14px;
    }
    .region-badge.at { background: linear-gradient(180deg, #ED2939 33%, #fff 33%, #fff 66%, #ED2939 66%); }
    .region-badge.de { background: linear-gradient(180deg, #000 33%, #D00 33%, #D00 66%, #FC0 66%); }
    .region-badge.ch { background: #D52B1E; color: #fff; }
    .region-badge.dk { background: #C8102E; color: #fff; }
    
    .selection-btn.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .selection-btn.disabled:hover {
      border-color: #e0e0e0;
      background: #fff;
      transform: none;
      box-shadow: none;
    }
    
    /* Search */
    .search-container { position: relative; margin-bottom: 16px; }
    .search-input {
      width: 100%;
      padding: 16px 16px 16px 48px;
      border: 2px solid #e0e0e0;
      border-radius: 14px;
      background: #fff;
      color: #333;
      font-size: 16px;
      transition: all 0.2s;
    }
    .search-input:focus {
      outline: none;
      border-color: #0055a4;
      box-shadow: 0 0 0 3px rgba(0, 85, 164, 0.1);
    }
    .search-input::placeholder { color: #999; }
    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 18px;
      height: 18px;
      border: 2px solid #999;
      border-radius: 50%;
    }
    .search-icon::after {
      content: '';
      position: absolute;
      width: 2px;
      height: 6px;
      background: #999;
      bottom: -5px;
      right: -2px;
      transform: rotate(-45deg);
    }
    .search-spinner {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border: 2px solid rgba(0, 85, 164, 0.3);
      border-top-color: #0055a4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }
    .search-spinner.show { display: block; }
    @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }
    
    /* Search Results */
    .search-results {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .search-results.show { display: block; }
    .search-result-item {
      padding: 14px 16px;
      cursor: pointer;
      transition: all 0.15s;
      border-bottom: 1px solid #f0f0f0;
    }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:hover { background: #f8f8f8; }
    .search-result-item .stop-name { font-weight: 600; font-size: 15px; margin-bottom: 4px; color: #333; }
    .search-result-item .stop-info { font-size: 12px; color: #888; }
    .no-results { padding: 20px; text-align: center; color: #888; }
    
    /* Lines Selection */
    .lines-container { margin-top: 16px; }
    .lines-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .lines-header h3 { font-size: 14px; color: #333; }
    .select-all-btn {
      font-size: 12px;
      color: #0055a4;
      background: none;
      border: none;
      cursor: pointer;
    }
    
    .line-group {
      margin-bottom: 16px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
    }
    .line-group-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: #f8f8f8;
      border-bottom: 1px solid #e0e0e0;
    }
    .line-group-header .line-badge {
      padding: 6px 14px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 15px;
      min-width: 50px;
      text-align: center;
    }
    /* Tram/Straßenbahn - Rot */
    .line-badge.type-tram {
      background: #c41e3a;
      color: #fff;
    }
    /* Bus - Blau */
    .line-badge.type-bus {
      background: #0055a4;
      color: #fff;
    }
    /* U-Bahn - Schwarz mit weißer Schrift */
    .line-badge.type-metro {
      background: #1a1a1a;
      color: #fff;
    }
    /* S-Bahn - Grün */
    .line-badge.type-suburban {
      background: #006e34;
      color: #fff;
    }
    /* Regional/Zug - Weiß mit schwarzer Schrift */
    .line-badge.type-train {
      background: #fff;
      color: #1a1a1a;
      border: 2px solid #1a1a1a;
    }
    /* Default */
    .line-badge.type-default {
      background: #666;
      color: #fff;
    }
    
    .line-group-header .line-name {
      font-weight: 600;
      font-size: 14px;
      color: #333;
    }
    .line-group-header .line-toggle {
      margin-left: auto;
      font-size: 12px;
      color: #0055a4;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
    }
    .line-group-header .line-toggle:hover {
      text-decoration: underline;
    }
    
    .line-directions {
      padding: 4px 0;
    }
    
    .direction-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .direction-option:hover {
      background: #f8f8f8;
    }
    .direction-option.selected {
      background: #e8f0f8;
    }
    .direction-option .checkbox {
      width: 22px;
      height: 22px;
      border: 2px solid #ccc;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      transition: all 0.15s;
    }
    .direction-option.selected .checkbox {
      background: #0055a4;
      border-color: #0055a4;
      color: #fff;
    }
    .direction-option .direction-text {
      font-size: 14px;
      color: #555;
    }
    .direction-option .direction-text::before {
      content: '→ ';
      color: #999;
    }
    
    .lines-loading {
      text-align: center;
      padding: 30px;
      color: #888;
    }
    .lines-loading .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #e0e0e0;
      border-top-color: #0055a4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    
    /* Station Chips */
    .station-chip {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #e8f5e9;
      border: 1px solid #a5d6a7;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 10px;
    }
    .station-chip.existing {
      background: #fff8e1;
      border-color: #ffe082;
    }
    .station-chip .network-badge {
      padding: 4px 10px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
      flex-shrink: 0;
    }
    /* Network colors - used by station chips */
    .station-chip .network-badge.wl { background: #E20613; color: #fff; }
    .station-chip .network-badge.wlb { background: #1E4D8C; color: #fff; }
    .station-chip .network-badge.linz { background: #009640; color: #fff; }
    .station-chip .network-badge.db { background: #EC0016; color: #fff; }
    .station-chip .network-badge.berlin { background: #F0AB00; color: #000; }
    .station-chip .network-badge.bodo { background: #005BBB; color: #fff; }
    .station-chip .network-badge.salzburg { background: #E3000F; color: #fff; }
    .station-chip .info { flex: 1; min-width: 0; }
    .station-chip .stop-name {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .station-chip .stop-details { font-size: 12px; color: #666; margin-top: 2px; }
    .station-chip .delete {
      background: #ffebee;
      border: none;
      color: #c62828;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .station-chip .delete:hover { background: #ffcdd2; }
    
    .empty-state {
      text-align: center;
      padding: 30px;
      color: #999;
    }
    .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
    
    /* Buttons */
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-primary {
      background: #0055a4;
      color: #fff;
    }
    .btn-primary:hover {
      background: #004080;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 85, 164, 0.3);
    }
    .btn-primary:disabled {
      background: #e0e0e0;
      color: #999;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      margin-top: 12px;
    }
    .btn-secondary:hover { background: #e0e0e0; }
    
    /* Bottom Bar */
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      padding: 16px 20px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    .bottom-bar .container { max-width: 500px; }
    .btn-save {
      background: #0055a4;
      color: #fff;
    }
    .btn-save:hover { background: #004080; }
    .btn-save:disabled { background: #e0e0e0; color: #999; cursor: not-allowed; }
    
    /* Back Button */
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #666;
      font-size: 14px;
      background: none;
      border: none;
      cursor: pointer;
      margin-bottom: 16px;
      padding: 8px 0;
    }
    .back-btn::before {
      content: '';
      display: inline-block;
      width: 8px;
      height: 8px;
      border-left: 2px solid currentColor;
      border-bottom: 2px solid currentColor;
      transform: rotate(45deg);
      margin-right: 4px;
    }
    .back-btn:hover { color: #0055a4; }
    
    /* Hidden */
    .hidden { display: none !important; }
    
    /* Display Config Step */
    .config-suggestion {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .suggestion-header {
      margin-bottom: 15px;
    }
    .suggestion-label {
      font-size: 13px;
      color: #666;
    }
    .suggestion-preview {
      display: flex;
      gap: 15px;
      align-items: center;
      background: #fff;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      border: 2px solid #0055a4;
    }
    .preview-image {
      width: 120px;
      height: 80px;
      background: #000;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      overflow: hidden;
      position: relative;
    }
    .preview-image .line-preview {
      display: flex;
      flex-direction: column;
      gap: 4px;
      width: 100%;
      padding: 8px;
    }
    .preview-image .line-row {
      display: flex;
      align-items: center;
      gap: 6px;
      animation: slideIn 0.5s ease-out;
    }
    .preview-image .line-badge {
      font-size: 8px;
      font-weight: bold;
      padding: 2px 4px;
      border-radius: 2px;
      color: #fff;
    }
    .preview-image .line-dest {
      font-size: 7px;
      color: #fff;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
    }
    .preview-image .line-time {
      font-size: 9px;
      color: #0f0;
      font-weight: bold;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-10px); }
      to { opacity: 1; transform: translateX(0); }
    }
    .preview-info {
      flex: 1;
    }
    .preview-title {
      font-weight: 600;
      font-size: 16px;
      color: #333;
      margin-bottom: 4px;
    }
    .preview-desc {
      font-size: 13px;
      color: #666;
    }
    .suggestion-details {
      display: flex;
      gap: 20px;
    }
    .detail-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .detail-label {
      font-size: 13px;
      color: #666;
    }
    .detail-value {
      font-size: 13px;
      font-weight: 600;
      color: #333;
    }
    .config-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .btn-large {
      padding: 16px 24px;
      font-size: 16px;
    }
    .finetuning-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #e0e0e0;
    }
    .finetuning-section h3 {
      font-size: 14px;
      color: #333;
      margin-bottom: 15px;
    }
    .finetuning-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }
    .finetuning-row label {
      min-width: 120px;
      font-size: 14px;
      color: #666;
    }
    .finetuning-row select {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
      color: #333;
    }
    .finetuning-row select:focus {
      outline: none;
      border-color: #0055a4;
    }

    /* Journey Mode Styles */
    .journey-field {
      margin-bottom: 12px;
    }
    .journey-field label {
      display: block;
      font-size: 13px;
      color: #666;
      margin-bottom: 6px;
      font-weight: 600;
    }
    .journey-arrow {
      text-align: center;
      padding: 8px 0;
    }
    .journey-arrow::before {
      content: '';
      display: inline-block;
      width: 12px;
      height: 12px;
      border-right: 3px solid #ccc;
      border-bottom: 3px solid #ccc;
      transform: rotate(45deg);
    }
    
    .journey-selected {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      background: #e8f0f8;
      border: 2px solid #0055a4;
      border-radius: 12px;
      margin-top: 8px;
    }
    .journey-selected .station-name {
      font-weight: 600;
      color: #333;
    }
    .journey-selected .change-btn {
      background: none;
      border: none;
      color: #0055a4;
      font-size: 13px;
      cursor: pointer;
    }
    .journey-selected .change-btn:hover {
      text-decoration: underline;
    }
    
    /* Product Selection */
    .journey-products {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e0e0e0;
    }
    
    .product-category {
      margin-bottom: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
    }
    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      background: #f8f9fa;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      color: #333;
    }
    .category-header:hover {
      background: #f0f2f4;
    }
    .category-toggle {
      color: #666;
      font-size: 12px;
      transition: transform 0.2s;
    }
    .category-content {
      background: #fff;
    }
    .category-content.collapsed {
      display: none;
    }
    
    .product-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: #fff;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: all 0.15s;
    }
    .product-option:last-child {
      border-bottom: none;
    }
    .product-option:hover {
      background: #f8f9fa;
    }
    .product-option.selected {
      background: #f0f5fa;
    }
    .product-option .checkbox {
      width: 24px;
      height: 24px;
      border: 2px solid #ccc;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }
    .product-option.selected .checkbox {
      background: #0055a4;
      border-color: #0055a4;
      color: #fff;
    }
    .product-option .product-badge {
      padding: 6px 14px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 14px;
      min-width: 50px;
      text-align: center;
      background: #1a1a1a;
      color: #fff;
    }
    .product-option .product-badge.ice { background: #fff; color: #1a1a1a; border: 2px solid #1a1a1a; }
    .product-option .product-badge.ic { background: #fff; color: #1a1a1a; border: 2px solid #1a1a1a; }
    .product-option .product-badge.rj { background: #c41e3a; color: #fff; }
    .product-option .product-badge.re { background: #006e34; color: #fff; }
    .product-option .product-badge.rb { background: #006e34; color: #fff; }
    .product-option .product-badge.s { background: #006e34; color: #fff; }
    .product-option .product-name {
      font-size: 14px;
      color: #333;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Städte & Netze</h1>
    <p>Wähle Stationen aus verschiedenen Verkehrsnetzen</p>
  </div>
  
  <!-- Breadcrumb -->
  <div class="breadcrumb" id="breadcrumb">
    <span class="breadcrumb-item active">Region wählen</span>
  </div>
  
  <!-- Step 1: Region -->
  <div class="card" id="stepRegion">
    <h2>Region wählen</h2>
    <div class="selection-grid">
      <button class="selection-btn" onclick="selectRegion('AT')">
        <div class="region-badge at"></div>
        <div class="name">Österreich</div>
        <div class="desc">Wien, Linz, Badner Bahn</div>
      </button>
      <button class="selection-btn" onclick="selectRegion('DE')">
        <div class="region-badge de"></div>
        <div class="name">Deutschland</div>
        <div class="desc">DB, Berlin, Bodensee</div>
      </button>
      <button class="selection-btn disabled" onclick="selectRegion('CH')">
        <div class="region-badge ch">CH</div>
        <div class="name">Schweiz</div>
        <div class="desc">Bald verfügbar</div>
      </button>
      <button class="selection-btn disabled" onclick="selectRegion('DK')">
        <div class="region-badge dk">DK</div>
        <div class="name">Dänemark</div>
        <div class="desc">Bald verfügbar</div>
      </button>
    </div>
  </div>
  
  <!-- Step 2: Network -->
  <div class="card hidden" id="stepNetwork">
    <button class="back-btn" onclick="goBack('region')">Zurück</button>
    <h2>Netzwerk wählen</h2>
    <div class="selection-grid" id="networkGrid"></div>
  </div>
  
  <!-- Step 3: Search Station (für normale Netze) -->
  <div class="card hidden" id="stepSearch">
    <button class="back-btn" onclick="goBack('network')">Zurück</button>
    <h2>Station suchen</h2>
    <div class="search-container">
      <span class="search-icon"></span>
      <input type="text" class="search-input" id="searchInput" placeholder="Stationsname eingeben..." autocomplete="off">
      <div class="search-spinner" id="searchSpinner"></div>
    </div>
    <div class="search-results" id="searchResults"></div>
  </div>
  
  <!-- Step 3b: Journey Search (für DB) -->
  <div class="card hidden" id="stepJourneySearch">
    <button class="back-btn" onclick="goBack('network')">Zurück</button>
    <h2>Verbindung wählen</h2>
    
    <div class="journey-field">
      <label>Von:</label>
      <div class="search-container">
        <span class="search-icon"></span>
        <input type="text" class="search-input" id="journeyFromInput" placeholder="Abfahrtsstation..." autocomplete="off">
        <div class="search-spinner" id="journeyFromSpinner"></div>
      </div>
      <div class="search-results" id="journeyFromResults"></div>
      <div class="journey-selected hidden" id="journeyFromSelected"></div>
    </div>
    
    <div class="journey-arrow"></div>
    
    <div class="journey-field">
      <label>Nach:</label>
      <div class="search-container">
        <span class="search-icon"></span>
        <input type="text" class="search-input" id="journeyToInput" placeholder="Zielstation..." autocomplete="off">
        <div class="search-spinner" id="journeyToSpinner"></div>
      </div>
      <div class="search-results" id="journeyToResults"></div>
      <div class="journey-selected hidden" id="journeyToSelected"></div>
    </div>
    
    <!-- Zugauswahl erscheint automatisch -->
    <div class="journey-products hidden" id="journeyProductsSection">
      <h3 style="color:#0055a4;margin:20px 0 12px;font-size:16px;">Züge auswählen</h3>
      
      <div class="product-category">
        <div class="category-header" onclick="toggleCategory('domestic')">
          <span>Deutsche Züge</span>
          <span class="category-toggle" id="domesticToggle">▼</span>
        </div>
        <div class="category-content" id="domesticProducts"></div>
      </div>
      
      <div class="product-category">
        <div class="category-header" onclick="toggleCategory('international')">
          <span>International</span>
          <span class="category-toggle" id="internationalToggle">▼</span>
        </div>
        <div class="category-content" id="internationalProducts"></div>
      </div>
      
      <button class="btn btn-primary" id="addJourneyBtn" onclick="addJourneyStation()" disabled style="margin-top:16px;width:100%">
        Verbindung hinzufügen
      </button>
    </div>
  </div>
  
  
  <!-- Step 4: Select Lines -->
  <div class="card hidden" id="stepLines">
    <button class="back-btn" onclick="goBack('search')">Zurück</button>
    <h2 id="selectedStationName" style="color:#0055a4;">Linien auswählen</h2>
    <p style="color:#666;font-size:13px;margin-bottom:16px;" id="selectedStationInfo"></p>
    
    <div class="lines-loading" id="linesLoading">
      <div class="spinner"></div>
      <div>Lade Abfahrten...</div>
    </div>
    
    <div class="lines-container hidden" id="linesContainer">
      <div class="lines-header">
        <h3>Welche Linien anzeigen?</h3>
        <button class="select-all-btn" id="selectAllBtn" onclick="toggleSelectAll()">Alle auswählen</button>
      </div>
      <div id="linesList"></div>
    </div>
    
    <button class="btn btn-primary" id="addStationBtn" onclick="addStation()" disabled>
      Station hinzufügen
    </button>
  </div>
  
  <!-- Added Stations -->
  <div class="card" id="stationsCard">
    <h2>Deine Stationen (<span id="stationCount">0</span>)</h2>
    <div id="stationsContainer">
      <div class="empty-state" id="emptyState">
        <p>Noch keine Stationen hinzugefügt</p>
      </div>
    </div>
  </div>
  
  <!-- Step: Display Config -->
  <div class="card hidden" id="stepDisplayConfig">
    <button class="back-btn" onclick="backFromDisplayConfig()">Zurück</button>
    <h2>Display-Einstellungen</h2>
    
    <div class="config-suggestion">
      <div class="suggestion-header">
        <span class="suggestion-label">Empfohlen für deine Auswahl:</span>
      </div>
      
      <div class="suggestion-preview" id="suggestionPreview">
        <div class="preview-image" id="previewImage">
          <!-- Animated preview -->
        </div>
        <div class="preview-info">
          <div class="preview-title" id="previewTitle">Wiener Linien Ansicht</div>
          <div class="preview-desc" id="previewDesc">2 Zeilen, optimal für U-Bahn und Tram</div>
        </div>
      </div>
      
      <div class="suggestion-details">
        <div class="detail-row">
          <span class="detail-label">Display-Typ:</span>
          <span class="detail-value" id="suggestedColorName">Wiener Linien</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Zeilen:</span>
          <span class="detail-value" id="suggestedRows">2</span>
        </div>
      </div>
    </div>
    
    <div class="config-actions">
      <button class="btn btn-primary btn-large" onclick="sendWithSuggestion()">
        Mit Empfehlung senden
      </button>
      <button class="btn btn-secondary" onclick="showFinetuning()">
        Feintuning
      </button>
    </div>
    
    <!-- Feintuning Section (hidden by default) -->
    <div class="finetuning-section hidden" id="finetuningSection">
      <h3>Feintuning</h3>
      
      <div class="finetuning-row">
        <label>Display-Typ:</label>
        <select id="colorSelect">
          <option value="1">Wiener Linien (Standard)</option>
          <option value="2">Linz AG</option>
          <option value="3">VBB Berlin</option>
          <option value="4">WLB Badner Bahn</option>
          <option value="5">DB S-Bahn</option>
          <option value="6">DB Fernverkehr</option>
          <option value="7">BODO Bodensee</option>
          <option value="8">Salzburg AG</option>
        </select>
      </div>
      
      <div class="finetuning-row">
        <label>Anzahl Zeilen:</label>
        <select id="rowsSelect">
          <option value="1">1 Zeile</option>
          <option value="2">2 Zeilen</option>
          <option value="3">3 Zeilen</option>
          <option value="4">4 Zeilen</option>
        </select>
      </div>
      
      <button class="btn btn-primary" onclick="sendWithCustomConfig()">
        Mit Einstellungen senden
      </button>
    </div>
  </div>
</div>

<!-- Bottom Bar -->
<div class="bottom-bar">
  <div class="container">
    <button class="btn btn-save" id="saveBtn" onclick="goToDisplayConfig()" disabled>
      Weiter
    </button>
  </div>
</div>

<script>
// ==================== CONFIG ====================
const REGIONS = {
  AT: {
    name: 'Österreich',
    networks: ['WL', 'WLB', 'LINZ', 'SALZBURG']
  },
  DE: {
    name: 'Deutschland', 
    networks: ['DB', 'BERLIN', 'BODO']
  },
  CH: {
    name: 'Schweiz',
    networks: []
  },
  DK: {
    name: 'Dänemark',
    networks: []
  }
};

const NETWORKS = {
  WL: {
    name: 'Wiener Linien',
    shortName: 'WL',
    region: 'AT',
    desc: 'U-Bahn, Straßenbahn, Bus',
    searchType: 'wien_json',
    placeholder: 'z.B. Karlsplatz, Stephansplatz...',
    isJourneyBased: false
  },
  LINZ: {
    name: 'Linz AG Linien',
    shortName: 'LINZ',
    region: 'AT', 
    desc: 'Straßenbahn, Bus',
    searchType: 'server_proxy',
    placeholder: 'z.B. Hauptbahnhof, Taubenmarkt...',
    isJourneyBased: false
  },
  WLB: {
    name: 'Wiener Lokalbahnen',
    shortName: 'WLB',
    region: 'AT',
    desc: 'Badner Bahn (Wien - Baden)',
    searchType: 'static_list',
    placeholder: 'Haltestelle auswählen...',
    isJourneyBased: false,
    stations: [
      // Wien
      { id: '490097507', name: 'Wien Oper/Karlsplatz', info: 'Kärntner Ring' },
      { id: '490065711', name: 'Wien Karlsplatz', info: '' },
      { id: '490109401', name: 'Wien Resselgasse', info: '' },
      { id: '490099601', name: 'Wien Paulanergasse', info: '' },
      { id: '490085902', name: 'Wien Mayerhofgasse', info: '' },
      { id: '490060401', name: 'Wien Johann-Strauß-Gasse', info: '' },
      { id: '490075502', name: 'Wien Laurenzgasse', info: '' },
      { id: '490068901', name: 'Wien Kliebergasse', info: '' },
      { id: '490084912', name: 'Wien Matzleinsdorfer Platz', info: '' },
      { id: '490026705', name: 'Wien Eichenstraße', info: 'Gürtel' },
      { id: '490084401', name: 'Wien Marx-Meidlinger-Straße', info: '' },
      { id: '490036801', name: 'Wien Längenfeldgasse', info: 'Flurschützstraße' },
      { id: '490010301', name: 'Wien Aßmayergasse', info: '' },
      { id: '490086503', name: 'Wien Dörfelstraße', info: '' },
      { id: '490101505', name: 'Wien Meidling', info: 'Bahnhof' },
      { id: '490116002', name: 'Wien Schedifkaplatz', info: 'Meidling' },
      { id: '490121402', name: 'Wien Schöpfwerk', info: '' },
      { id: '490044401', name: 'Wien Gutheil-Schoder-Gasse', info: '' },
      { id: '490058502', name: 'Wien Inzersdorf Lokalbahn', info: '' },
      { id: '490091801', name: 'Wien Neu Erlaa', info: '' },
      { id: '490075902', name: 'Wien Schönbrunner Allee', info: '' },
      // Niederösterreich
      { id: '430513303', name: 'Vösendorf-Siebenhirten', info: '' },
      { id: '430513202', name: 'Vösendorf SCS', info: 'Shopping City Süd' },
      { id: '430416402', name: 'Maria Enzersdorf-Südstadt', info: 'Bahnhof' },
      { id: '430520106', name: 'Wiener Neudorf Bahnhof', info: '' },
      { id: '430520001', name: 'Wiener Neudorf Griesfeld', info: '' },
      { id: '430433104', name: 'Neu-Guntramsdorf', info: 'Lokalbahn' },
      { id: '430361504', name: 'Guntramsdorf Lokalbahn', info: '' },
      { id: '430430202', name: 'Eigenheimsiedlung', info: '' },
      { id: '430430404', name: 'Möllersdorf Lokalbahn', info: '' },
      { id: '430500104', name: 'Traiskirchen Lokalbahn', info: '' },
      { id: '430502202', name: 'Tribuswinkel-Josefsthal', info: 'Bahnhof' },
      { id: '430453602', name: 'Pfaffstätten Rennplatz', info: '' },
      { id: '430580902', name: 'Baden Melkergründe', info: '' },
      { id: '430605501', name: 'Baden Landesklinikum', info: '' },
      { id: '430314203', name: 'Baden Leesdorf', info: '' },
      { id: '430313402', name: 'Baden Viadukt', info: '' },
      { id: '430312101', name: 'Baden Josefsplatz', info: 'Endstation' }
    ]
  },
  SALZBURG: {
    name: 'Salzburg Verkehr (SVV)',
    shortName: 'SBG',
    region: 'AT',
    desc: 'Obus, Lokalbahn, Pinzgauer Bahn, Regionalbusse (Fahrplan)',
    searchType: 'static_list',
    placeholder: 'Haltestelle suchen...',
    isJourneyBased: false,
    stations: [
      // === STADT SALZBURG ===
      { id: 'Salzburg Hauptbahnhof', name: 'Salzburg Hauptbahnhof', info: 'Obus, Lokalbahn, S-Bahn' },
      { id: 'Mirabellplatz', name: 'Mirabellplatz', info: 'Obus 1,2,5,6' },
      { id: 'Makartplatz', name: 'Makartplatz', info: 'Obus 3,5,6' },
      { id: 'Rathaus', name: 'Rathaus', info: 'Obus 3,5,6,8' },
      { id: 'Hanuschplatz', name: 'Hanuschplatz', info: 'Obus 1,2,4,7' },
      { id: 'Mozartsteg', name: 'Mozartsteg', info: 'Obus 3,7,8' },
      { id: 'Theatergasse', name: 'Theatergasse', info: 'Obus' },
      { id: 'Ferdinand-Hanusch-Platz', name: 'Ferdinand-Hanusch-Platz', info: 'Obus' },
      { id: 'Salzburg Süd', name: 'Salzburg Süd P+R', info: 'Obus 3,8' },
      { id: 'Europark', name: 'Europark', info: 'Obus 1,10' },
      { id: 'Flughafen', name: 'Salzburg Flughafen', info: 'Obus 2,10' },
      { id: 'Paris-Lodron-Straße', name: 'Universität', info: 'Obus 4,7' },
      { id: 'Gnigl', name: 'Gnigl', info: 'Obus 5,6' },
      { id: 'Maxglan West', name: 'Maxglan West', info: 'Obus 1' },
      { id: 'Itzling', name: 'Itzling', info: 'Obus, S-Bahn' },
      { id: 'Aiglhof', name: 'Aiglhof', info: 'Lokalbahn' },
      { id: 'Sam', name: 'Sam', info: 'Lokalbahn' },
      // === LOKALBAHN S1/S11 ===
      { id: 'Oberndorf', name: 'Oberndorf bei Salzburg', info: 'Lokalbahn S1/S11' },
      { id: 'Bürmoos', name: 'Bürmoos', info: 'Lokalbahn S1' },
      { id: 'Lamprechtshausen', name: 'Lamprechtshausen', info: 'Lokalbahn S1' },
      { id: 'Trimmelkam', name: 'Trimmelkam', info: 'Lokalbahn S11' },
      // === FLACHGAU ===
      { id: 'Seekirchen', name: 'Seekirchen am Wallersee', info: 'S-Bahn, Bus' },
      { id: 'Eugendorf', name: 'Eugendorf', info: 'S-Bahn, Bus' },
      { id: 'Mattsee', name: 'Mattsee', info: 'Bus' },
      { id: 'Straßwalchen', name: 'Straßwalchen', info: 'S-Bahn, Bus' },
      { id: 'Neumarkt am Wallersee', name: 'Neumarkt am Wallersee', info: 'S-Bahn' },
      { id: 'Thalgau', name: 'Thalgau', info: 'Bus' },
      { id: 'Mondsee', name: 'Mondsee', info: 'Bus' },
      // === TENNENGAU ===
      { id: 'Hallein', name: 'Hallein', info: 'S-Bahn S3, Bus' },
      { id: 'Hallein Burgfried', name: 'Hallein Burgfried', info: 'S-Bahn S3' },
      { id: 'Bad Dürrnberg', name: 'Bad Dürrnberg', info: 'Bus' },
      { id: 'Golling', name: 'Golling-Abtenau', info: 'S-Bahn S3, Bus' },
      { id: 'Kuchl', name: 'Kuchl', info: 'S-Bahn S3' },
      { id: 'Abtenau', name: 'Abtenau', info: 'Bus' },
      // === PONGAU ===
      { id: 'St. Johann im Pongau', name: 'St. Johann im Pongau', info: 'S-Bahn, REX, Bus' },
      { id: 'Bischofshofen', name: 'Bischofshofen', info: 'S-Bahn, REX, IC' },
      { id: 'Schwarzach-St. Veit', name: 'Schwarzach-St. Veit', info: 'IC, REX, S-Bahn' },
      { id: 'Werfen', name: 'Werfen', info: 'S-Bahn S3' },
      { id: 'Pfarrwerfen', name: 'Pfarrwerfen', info: 'S-Bahn S3' },
      { id: 'Bad Gastein', name: 'Bad Gastein', info: 'IC, REX, Bus' },
      { id: 'Bad Hofgastein', name: 'Bad Hofgastein', info: 'REX, Bus' },
      { id: 'Dorfgastein', name: 'Dorfgastein', info: 'REX' },
      { id: 'Radstadt', name: 'Radstadt', info: 'Bus' },
      { id: 'Altenmarkt im Pongau', name: 'Altenmarkt im Pongau', info: 'Bus' },
      { id: 'Wagrain', name: 'Wagrain', info: 'Bus' },
      { id: 'Flachau', name: 'Flachau', info: 'Bus' },
      // === PINZGAU ===
      { id: 'Zell am See', name: 'Zell am See', info: 'IC, REX, Pinzgauer Bahn' },
      { id: 'Zell am See Postplatz', name: 'Zell am See Postplatz', info: 'Bus' },
      { id: 'Kaprun', name: 'Kaprun', info: 'Pinzgauer Bahn, Bus' },
      { id: 'Piesendorf', name: 'Piesendorf', info: 'Pinzgauer Bahn' },
      { id: 'Niedernsill', name: 'Niedernsill', info: 'Pinzgauer Bahn' },
      { id: 'Uttendorf-Stubachtal', name: 'Uttendorf-Stubachtal', info: 'Pinzgauer Bahn' },
      { id: 'Stuhlfelden', name: 'Stuhlfelden', info: 'Pinzgauer Bahn' },
      { id: 'Mittersill', name: 'Mittersill', info: 'Pinzgauer Bahn, Bus' },
      { id: 'Bramberg', name: 'Bramberg am Wildkogel', info: 'Pinzgauer Bahn' },
      { id: 'Neukirchen am Großvenediger', name: 'Neukirchen am Großvenediger', info: 'Pinzgauer Bahn' },
      { id: 'Wald im Pinzgau', name: 'Wald im Pinzgau', info: 'Pinzgauer Bahn' },
      { id: 'Krimml', name: 'Krimml', info: 'Pinzgauer Bahn Endstation' },
      { id: 'Saalfelden', name: 'Saalfelden am Steinernen Meer', info: 'REX, S-Bahn, Bus' },
      { id: 'Leogang', name: 'Leogang', info: 'Bus' },
      { id: 'Maria Alm', name: 'Maria Alm', info: 'Bus' },
      { id: 'Lofer', name: 'Lofer', info: 'Bus' },
      { id: 'Fieberbrunn', name: 'Fieberbrunn', info: 'REX, Bus' },
      // === LUNGAU ===
      { id: 'Tamsweg', name: 'Tamsweg', info: 'Bus' },
      { id: 'Mauterndorf', name: 'Mauterndorf', info: 'Bus' },
      { id: 'St. Michael im Lungau', name: 'St. Michael im Lungau', info: 'Bus' },
      { id: 'Mariapfarr', name: 'Mariapfarr', info: 'Bus' },
      { id: 'Muhr', name: 'Muhr', info: 'Bus' }
    ]
  },
  DB: {
    name: 'Deutsche Bahn',
    shortName: 'DB',
    region: 'DE',
    desc: 'ICE, IC, RJ, RE, S-Bahn',
    searchType: 'server_proxy',
    placeholder: 'z.B. München Hbf, Berlin Hbf...',
    isJourneyBased: true,
    productCategories: {
      domestic: {
        label: 'Deutsche Züge',
        products: [
          { id: 'ICE', name: 'ICE', desc: 'Intercity-Express' },
          { id: 'IC', name: 'IC', desc: 'Intercity' },
          { id: 'EC', name: 'EC', desc: 'Eurocity' },
          { id: 'RE', name: 'RE', desc: 'Regional-Express' },
          { id: 'RB', name: 'RB', desc: 'Regionalbahn' },
          { id: 'S', name: 'S', desc: 'S-Bahn' }
        ]
      },
      international: {
        label: 'International',
        products: [
          { id: 'RJX', name: 'RJX', desc: 'Railjet Xpress (ÖBB)' },
          { id: 'RJ', name: 'RJ', desc: 'Railjet (ÖBB)' },
          { id: 'NJ', name: 'NJ', desc: 'Nightjet (ÖBB)' },
          { id: 'TGV', name: 'TGV', desc: 'TGV (SNCF)' },
          { id: 'THA', name: 'THA', desc: 'Thalys' },
          { id: 'FLX', name: 'FLX', desc: 'Flixtrain' }
        ]
      }
    }
  },
  BERLIN: {
    name: 'VBB Berlin',
    shortName: 'VBB',
    region: 'DE',
    desc: 'U-Bahn, S-Bahn, Tram, Bus',
    searchType: 'server_proxy',
    placeholder: 'z.B. Alexanderplatz...',
    isJourneyBased: false
  },
  BODO: {
    name: 'BODO',
    shortName: 'BODO',
    region: 'DE',
    desc: 'Bodensee-Oberschwaben',
    searchType: 'server_proxy',
    placeholder: 'z.B. Friedrichshafen...',
    isJourneyBased: false
  }
};

const SEARCH_API = 'https://api.straba.at/api/v1/stops/search';
const DEPARTURES_API = 'https://api.straba.at/api/v1/wl/departures';
const WIEN_DATA_URL = 'https://straba-983965425140.europe-west3.run.app/search/';

// ==================== STATE ====================
let currentStep = 'region';
let selectedRegion = null;
let selectedNetwork = null;
let selectedStop = null;
let availableLines = [];
let selectedLines = new Set();
let stations = [];
let wienData = null;
let searchTimeout = null;

// Journey-Modus (für DB)
let journeyFromStop = null;
let journeyToStop = null;
let selectedProducts = new Set();

// ==================== DOM ====================
const stepRegion = document.getElementById('stepRegion');
const stepNetwork = document.getElementById('stepNetwork');
const stepSearch = document.getElementById('stepSearch');
const stepLines = document.getElementById('stepLines');
const networkGrid = document.getElementById('networkGrid');
const searchInput = document.getElementById('searchInput');
const searchSpinner = document.getElementById('searchSpinner');
const searchResults = document.getElementById('searchResults');
const linesLoading = document.getElementById('linesLoading');
const linesContainer = document.getElementById('linesContainer');
const linesList = document.getElementById('linesList');
const addStationBtn = document.getElementById('addStationBtn');
const stationsContainer = document.getElementById('stationsContainer');
const emptyState = document.getElementById('emptyState');
const stationCount = document.getElementById('stationCount');
const saveBtn = document.getElementById('saveBtn');
const breadcrumb = document.getElementById('breadcrumb');

// ==================== NAVIGATION ====================
function showStep(step) {
  currentStep = step;
  stepRegion.classList.toggle('hidden', step !== 'region');
  stepNetwork.classList.toggle('hidden', step !== 'network');
  stepSearch.classList.toggle('hidden', step !== 'search');
  stepLines.classList.toggle('hidden', step !== 'lines');
  
  // Journey-Modus Steps
  const stepJourneySearch = document.getElementById('stepJourneySearch');
  if (stepJourneySearch) stepJourneySearch.classList.toggle('hidden', step !== 'journeySearch');
  
  updateBreadcrumb();
}

function updateBreadcrumb() {
  let html = '';
  
  html += `<span class="breadcrumb-item ${currentStep === 'region' ? 'active' : ''}" onclick="goBack('region')">Region</span>`;
  
  if (selectedRegion) {
    html += `<span class="breadcrumb-sep">›</span>`;
    html += `<span class="breadcrumb-item ${currentStep === 'network' ? 'active' : ''}" onclick="goBack('network')">${REGIONS[selectedRegion].name}</span>`;
  }
  
  if (selectedNetwork) {
    html += `<span class="breadcrumb-sep">›</span>`;
    const isJourney = NETWORKS[selectedNetwork].isJourneyBased;
    const backStep = isJourney ? 'journeySearch' : 'search';
    html += `<span class="breadcrumb-item ${currentStep === 'search' || currentStep === 'journeySearch' ? 'active' : ''}" onclick="goBack('${backStep}')">${NETWORKS[selectedNetwork].name}</span>`;
  }
  
  if (selectedStop && currentStep === 'lines') {
    html += `<span class="breadcrumb-sep">›</span>`;
    html += `<span class="breadcrumb-item active">${selectedStop.name}</span>`;
  }
  
  breadcrumb.innerHTML = html;
}

function goBack(step) {
  if (step === 'region') {
    selectedRegion = null;
    selectedNetwork = null;
    selectedStop = null;
    journeyFromStop = null;
    journeyToStop = null;
    selectedProducts = new Set();
  } else if (step === 'network') {
    selectedNetwork = null;
    selectedStop = null;
    journeyFromStop = null;
    journeyToStop = null;
    selectedProducts = new Set();
    // Hide products section
    const productsSection = document.getElementById('journeyProductsSection');
    if (productsSection) productsSection.classList.add('hidden');
  } else if (step === 'search') {
    selectedStop = null;
    searchInput.value = '';
    searchResults.classList.remove('show');
  } else if (step === 'journeySearch') {
    selectedProducts = new Set();
    // Hide products section when going back
    const productsSection = document.getElementById('journeyProductsSection');
    if (productsSection) productsSection.classList.add('hidden');
  }
  showStep(step);
}

// ==================== REGION SELECTION ====================
function selectRegion(region) {
  if (REGIONS[region].networks.length === 0) return;
  
  selectedRegion = region;
  renderNetworkGrid();
  showStep('network');
}

function renderNetworkGrid() {
  const networks = REGIONS[selectedRegion].networks;
  
  networkGrid.innerHTML = networks.map(id => {
    const net = NETWORKS[id];
    const badgeClass = id.toLowerCase();
    return `
      <button class="selection-btn" onclick="selectNetwork('${id}')">
        <div class="network-badge ${badgeClass}">${net.shortName || id}</div>
        <div class="name">${net.name}</div>
        <div class="desc">${net.desc}</div>
      </button>
    `;
  }).join('');
}

// ==================== NETWORK SELECTION ====================
function selectNetwork(network) {
  selectedNetwork = network;
  const netConfig = NETWORKS[network];
  
  // Journey-basierte Netzwerke (DB)
  if (netConfig.isJourneyBased) {
    journeyFromStop = null;
    journeyToStop = null;
    selectedProducts = new Set();
    
    // Reset form
    const fromInput = document.getElementById('journeyFromInput');
    const toInput = document.getElementById('journeyToInput');
    const fromSelected = document.getElementById('journeyFromSelected');
    const toSelected = document.getElementById('journeyToSelected');
    const fromResults = document.getElementById('journeyFromResults');
    const toResults = document.getElementById('journeyToResults');
    const productsSection = document.getElementById('journeyProductsSection');
    
    if (fromInput) {
      fromInput.value = '';
      fromInput.placeholder = netConfig.placeholder;
      fromInput.parentElement.classList.remove('hidden');
    }
    if (toInput) {
      toInput.value = '';
      toInput.placeholder = netConfig.placeholder;
      toInput.parentElement.classList.remove('hidden');
    }
    if (fromSelected) fromSelected.classList.add('hidden');
    if (toSelected) toSelected.classList.add('hidden');
    if (fromResults) fromResults.classList.remove('show');
    if (toResults) toResults.classList.remove('show');
    if (productsSection) productsSection.classList.add('hidden');
    
    showStep('journeySearch');
    return;
  }
  
  // Normale Netzwerke
  searchInput.placeholder = netConfig.placeholder;
  searchInput.value = '';
  searchResults.classList.remove('show');
  
  if (network === 'WL' && !wienData) {
    loadWienData();
  }
  
  showStep('search');
  searchInput.focus();
}

// ==================== WIEN DATA ====================
async function loadWienData() {
  try {
    const response = await fetch(WIEN_DATA_URL);
    wienData = await response.json();
  } catch (e) {
    console.error('Failed to load Wien data:', e);
  }
}

// ==================== SEARCH ====================
searchInput.addEventListener('input', function() {
  const query = this.value.trim();
  if (searchTimeout) clearTimeout(searchTimeout);
  
  const netConfig = NETWORKS[selectedNetwork];
  
  // Bei static_list: auch bei leerem Query alle anzeigen
  if (netConfig?.searchType === 'static_list') {
    if (query.length === 0) {
      displaySearchResults(netConfig.stations);
      return;
    }
    searchTimeout = setTimeout(() => performSearch(query), 100);
    return;
  }
  
  if (query.length < 2) {
    searchResults.classList.remove('show');
    return;
  }
  
  searchTimeout = setTimeout(() => performSearch(query), 300);
});

// Bei static_list: Klick ins Suchfeld zeigt alle Stationen
searchInput.addEventListener('focus', function() {
  const netConfig = NETWORKS[selectedNetwork];
  if (netConfig?.searchType === 'static_list' && this.value.trim().length === 0) {
    displaySearchResults(netConfig.stations);
  }
});

async function performSearch(query) {
  if (!selectedNetwork) return;
  
  searchSpinner.classList.add('show');
  
  try {
    let results = [];
    const netConfig = NETWORKS[selectedNetwork];
    
    if (netConfig.searchType === 'wien_json') {
      results = searchWien(query);
    } else if (netConfig.searchType === 'static_list') {
      results = searchStaticList(netConfig.stations, query);
    } else {
      results = await searchViaProxy(selectedNetwork, query);
    }
    
    displaySearchResults(results);
  } catch (e) {
    console.error('Search error:', e);
    searchResults.innerHTML = '<div class="no-results">Fehler bei der Suche</div>';
    searchResults.classList.add('show');
  } finally {
    searchSpinner.classList.remove('show');
  }
}

function searchStaticList(stations, query) {
  if (!stations) return [];
  if (!query || query.length === 0) return stations.slice(0, 30); // Alle anzeigen (max 30)
  
  const q = query.toLowerCase();
  return stations
    .filter(s => s.name.toLowerCase().includes(q) || (s.info && s.info.toLowerCase().includes(q)))
    .slice(0, 15);
}

function searchWien(query) {
  if (!wienData) return [];
  
  const q = query.toLowerCase();
  const stationsMap = new Map();
  
  wienData.forEach(line => {
    if (!Array.isArray(line.lineStation)) return;
    line.lineStation.forEach(item => {
      const station = item.station;
      if (!station || !station.stationName || !station.stationID) return;
      if (station.stationName.toLowerCase().includes(q)) {
        const id = station.stationID;
        if (!stationsMap.has(id)) {
          stationsMap.set(id, { id: String(id), name: station.stationName, lines: new Set() });
        }
        stationsMap.get(id).lines.add(line.lineName);
      }
    });
  });
  
  return Array.from(stationsMap.values())
    .map(s => ({
      id: s.id,
      name: s.name,
      info: Array.from(s.lines).slice(0, 5).join(', ') + (s.lines.size > 5 ? '...' : '')
    }))
    .slice(0, 15);
}

async function searchViaProxy(network, query) {
  const params = new URLSearchParams({ network, q: query });
  const response = await fetch(`${SEARCH_API}?${params}`);
  const data = await response.json();
  return (data.stops || []).map(s => ({ id: s.id, name: s.name, info: s.info || '' }));
}

function displaySearchResults(results) {
  if (results.length === 0) {
    searchResults.innerHTML = '<div class="no-results">Keine Stationen gefunden</div>';
  } else {
    searchResults.innerHTML = results.map(r => `
      <div class="search-result-item" onclick="selectStop('${r.id}', '${r.name.replace(/'/g, "\\'")}')">
        <div class="stop-name">${r.name}</div>
        <div class="stop-info">${r.info || `ID: ${r.id}`}</div>
      </div>
    `).join('');
  }
  searchResults.classList.add('show');
}

// ==================== STOP SELECTION ====================
async function selectStop(id, name) {
  selectedStop = { id, name };
  selectedLines = new Set();
  availableLines = [];
  
  document.getElementById('selectedStationName').textContent = name;
  document.getElementById('selectedStationInfo').textContent = `${NETWORKS[selectedNetwork].name} · ID: ${id}`;
  
  searchResults.classList.remove('show');
  showStep('lines');
  
  // Load departures to get available lines
  linesLoading.classList.remove('hidden');
  linesContainer.classList.add('hidden');
  addStationBtn.disabled = true;
  
  try {
    const fullId = `${selectedNetwork}:${id}`;
    const response = await fetch(`${DEPARTURES_API}?stopId=${fullId}`);
    const data = await response.json();
    
    extractLines(data);
    renderLines();
    
    linesLoading.classList.add('hidden');
    linesContainer.classList.remove('hidden');
  } catch (e) {
    console.error('Failed to load departures:', e);
    linesLoading.innerHTML = '<div style="color:#d32f2f">Fehler beim Laden der Linien</div>';
  }
}

function extractLines(data) {
  const linesMap = new Map();
  
  if (data.data && data.data.monitors) {
    data.data.monitors.forEach(monitor => {
      if (monitor.lines) {
        monitor.lines.forEach(line => {
          const name = line.name || '?';
          const towards = line.towards || '';
          const key = `${name}|${towards}`;
          
          if (!linesMap.has(key)) {
            linesMap.set(key, { name, towards, type: line.type || '' });
          }
        });
      }
    });
  }
  
  availableLines = Array.from(linesMap.values());
  
  availableLines.sort((a, b) => {
    const aNum = parseInt(a.name) || 999;
    const bNum = parseInt(b.name) || 999;
    if (aNum !== bNum) return aNum - bNum;
    return a.name.localeCompare(b.name);
  });
}

function renderLines() {
  if (availableLines.length === 0) {
    linesList.innerHTML = '<div class="no-results">Keine Abfahrten gefunden</div>';
    return;
  }
  
  // Group by line name
  const groups = new Map();
  availableLines.forEach((line, idx) => {
    if (!groups.has(line.name)) {
      groups.set(line.name, []);
    }
    groups.get(line.name).push({ ...line, idx });
  });
  
  let html = '';
  groups.forEach((directions, lineName) => {
    const allSelected = directions.every(d => selectedLines.has(d.idx));
    const someSelected = directions.some(d => selectedLines.has(d.idx));
    const lineType = directions[0]?.type || '';
    const badgeClass = getLineTypeClass(lineType, lineName);
    
    html += `
      <div class="line-group">
        <div class="line-group-header">
          <div class="line-badge ${badgeClass}">${lineName}</div>
          <div class="line-name">Linie ${lineName}</div>
          <button class="line-toggle" onclick="toggleLineGroup('${lineName}')">${allSelected ? 'Abwählen' : 'Alle'}</button>
        </div>
        <div class="line-directions">
    `;
    
    directions.forEach(dir => {
      const selected = selectedLines.has(dir.idx);
      html += `
        <div class="direction-option ${selected ? 'selected' : ''}" onclick="toggleLine(${dir.idx})">
          <div class="checkbox">${selected ? '✓' : ''}</div>
          <div class="direction-text">${dir.towards || 'Alle Richtungen'}</div>
        </div>
      `;
    });
    
    html += `
        </div>
      </div>
    `;
  });
  
  linesList.innerHTML = html;
  updateAddButton();
  updateSelectAllButton();
}

function getLineTypeClass(type, lineName) {
  // Normalize type
  const t = (type || '').toLowerCase();
  
  // 1. Wenn API einen klaren Typ liefert, verwende diesen
  
  // Tram / Straßenbahn
  if (t.includes('tram') || t.includes('strassenbahn') || t === 'pttram' || t === 'pttramwlb') {
    return 'type-tram';
  }
  
  // U-Bahn / Metro
  if (t.includes('metro') || t.includes('ubahn') || t === 'ptmetro') {
    return 'type-metro';
  }
  
  // S-Bahn
  if (t.includes('suburban') || t === 'pttrains') {
    return 'type-suburban';
  }
  
  // Regional / Zug
  if (t.includes('train') || t.includes('regional') || t.includes('express') || 
      t === 'pttrain' || t === 'pttrainr') {
    return 'type-train';
  }
  
  // Bus explizit
  if (t.includes('bus') || t === 'ptbuscity' || t === 'ptbusnight') {
    return 'type-bus';
  }
  
  // 2. Wenn kein klarer Typ, rate basierend auf Linienname
  
  // U-Bahn: U1, U2, etc.
  if (/^U\d+$/.test(lineName)) {
    return 'type-metro';
  }
  
  // S-Bahn: S1, S2, S7, etc.
  if (/^S\d+$/.test(lineName)) {
    return 'type-suburban';
  }
  
  // Zug: RE, RB, IC, EC, ICE
  if (/^(RE|RB|IC|EC|ICE|IR|R)\d*$/.test(lineName)) {
    return 'type-train';
  }
  
  // Bus: Hat Buchstaben am Ende (7A, 26A, 29B, 35A) oder ist dreistellig+
  if (/^\d+[A-Z]$/.test(lineName) || /^\d{3,}$/.test(lineName)) {
    return 'type-bus';
  }
  
  // Niedrige Nummern (1-19) ohne Buchstaben = wahrscheinlich Tram
  // (In Wien, Linz, etc. sind das typischerweise Straßenbahnlinien)
  const num = parseInt(lineName);
  if (!isNaN(num) && num >= 1 && num <= 19 && /^\d+$/.test(lineName)) {
    return 'type-tram';
  }
  
  // Mittlere Nummern (20-99) ohne Buchstaben = wahrscheinlich Bus
  if (!isNaN(num) && num >= 20 && num <= 99 && /^\d+$/.test(lineName)) {
    return 'type-bus';
  }
  
  // Default
  return 'type-default';
}

function toggleLineGroup(lineName) {
  const directions = availableLines
    .map((line, idx) => ({ ...line, idx }))
    .filter(line => line.name === lineName);
  
  const allSelected = directions.every(d => selectedLines.has(d.idx));
  
  if (allSelected) {
    directions.forEach(d => selectedLines.delete(d.idx));
  } else {
    directions.forEach(d => selectedLines.add(d.idx));
  }
  
  renderLines();
}

function toggleLine(idx) {
  if (selectedLines.has(idx)) {
    selectedLines.delete(idx);
  } else {
    selectedLines.add(idx);
  }
  renderLines();
}

function toggleSelectAll() {
  if (selectedLines.size === availableLines.length) {
    selectedLines.clear();
  } else {
    availableLines.forEach((_, idx) => selectedLines.add(idx));
  }
  renderLines();
}

function updateSelectAllButton() {
  const btn = document.getElementById('selectAllBtn');
  btn.textContent = selectedLines.size === availableLines.length ? 'Alle abwählen' : 'Alle auswählen';
}

function updateAddButton() {
  addStationBtn.disabled = selectedLines.size === 0;
}

// ==================== ADD STATION ====================
function addStation() {
  if (!selectedNetwork || !selectedStop || selectedLines.size === 0) return;
  
  const selectedLineNames = Array.from(selectedLines).map(idx => availableLines[idx].name);
  const uniqueLineNames = [...new Set(selectedLineNames)];
  const filter = uniqueLineNames.join(',');
  
  const fullId = `${selectedNetwork}:${selectedStop.id}`;
  
  // Check duplicate
  if (stations.some(s => s.fullId === fullId)) {
    alert('Diese Station ist bereits hinzugefügt!');
    return;
  }
  
  stations.push({
    network: selectedNetwork,
    networkName: NETWORKS[selectedNetwork].name,
    stopId: selectedStop.id,
    stopName: selectedStop.name,
    filter: filter,
    fullId: fullId,
    isExisting: false
  });
  
  // Reset and go back
  selectedStop = null;
  selectedLines = new Set();
  goBack('region');
  updateStationsList();
}

function removeStation(idx) {
  stations.splice(idx, 1);
  updateStationsList();
}

function updateStationsList() {
  stationCount.textContent = stations.length;
  
  if (stations.length === 0) {
    emptyState.style.display = 'block';
    saveBtn.disabled = true;
  } else {
    emptyState.style.display = 'none';
    saveBtn.disabled = false;
  }
  
  const chips = stations.map((s, idx) => {
    const filterLabel = s.isJourney ? `Produkte: ${s.filter}` : `Linien: ${s.filter || 'Alle'}`;
    const badgeClass = s.network.toLowerCase();
    
    return `
      <div class="station-chip ${s.isExisting ? 'existing' : ''} ${s.isJourney ? 'journey' : ''}">
        <span class="network-badge ${badgeClass}">${s.network}</span>
        <div class="info">
          <div class="stop-name">${s.stopName}</div>
          <div class="stop-details">${filterLabel}</div>
        </div>
        <button class="delete" onclick="removeStation(${idx})">×</button>
      </div>
    `;
  }).join('');
  
  const existingChips = stationsContainer.querySelectorAll('.station-chip');
  existingChips.forEach(c => c.remove());
  emptyState.insertAdjacentHTML('beforebegin', chips);
}

// ==================== DISPLAY CONFIG ====================
const NETWORK_COLORS = {
  WL: { id: 1, name: 'Wiener Linien', color: '#E20613' },
  WLB: { id: 4, name: 'WLB Badner Bahn', color: '#1E4D8C' },
  LINZ: { id: 2, name: 'Linz AG', color: '#009640' },
  SALZBURG: { id: 8, name: 'Salzburg AG', color: '#E3000F' },
  DB_FERN: { id: 6, name: 'DB Fernverkehr', color: '#EC0016' },
  DB_SBAHN: { id: 5, name: 'DB S-Bahn', color: '#009640' },
  BERLIN: { id: 3, name: 'VBB Berlin', color: '#F0AB00' },
  BODO: { id: 7, name: 'BODO Bodensee', color: '#005BBB' }
};

let suggestedColor = 1;
let suggestedRows = 2;

function goToDisplayConfig() {
  if (stations.length === 0) return;
  
  // Calculate suggestion
  const suggestion = suggestDisplayConfig();
  suggestedColor = suggestion.color;
  suggestedRows = suggestion.rows;
  
  // Update UI
  document.getElementById('suggestedColorName').textContent = suggestion.colorName;
  document.getElementById('suggestedRows').textContent = suggestion.rows + ' Zeile' + (suggestion.rows > 1 ? 'n' : '');
  document.getElementById('previewTitle').textContent = suggestion.colorName + ' Ansicht';
  document.getElementById('previewDesc').textContent = suggestion.description;
  
  // Update selects
  document.getElementById('colorSelect').value = suggestion.color;
  document.getElementById('rowsSelect').value = suggestion.rows;
  
  // Update preview animation
  updatePreviewAnimation(suggestion);
  
  // Hide finetuning
  document.getElementById('finetuningSection').classList.add('hidden');
  
  // Show config step, hide others
  document.getElementById('stationsCard').classList.add('hidden');
  document.getElementById('stepDisplayConfig').classList.remove('hidden');
  document.querySelector('.bottom-bar').style.display = 'none';
}

function suggestDisplayConfig() {
  // Count networks
  const networkCounts = {};
  stations.forEach(s => {
    networkCounts[s.network] = (networkCounts[s.network] || 0) + 1;
  });
  
  // Find dominant network
  const dominantNetwork = Object.entries(networkCounts)
    .sort((a, b) => b[1] - a[1])[0][0];
  
  // Determine color
  let colorId, colorName, description;
  
  if (dominantNetwork === 'DB') {
    // Check for S-Bahn vs Fernverkehr
    const dbStations = stations.filter(s => s.network === 'DB');
    let hasSBahn = false;
    let hasFernverkehr = false;
    
    dbStations.forEach(s => {
      const products = s.filter || s.products || '';
      if (products.includes('S')) hasSBahn = true;
      if (/ICE|IC|EC|RJ|RJX|NJ|TGV|THA|EN/.test(products)) hasFernverkehr = true;
    });
    
    if (hasFernverkehr && !hasSBahn) {
      colorId = 6;
      colorName = 'DB Fernverkehr';
      description = 'Optimiert für ICE, IC, RJ Anzeige';
    } else if (hasSBahn && !hasFernverkehr) {
      colorId = 5;
      colorName = 'DB S-Bahn';
      description = 'Optimiert für S-Bahn Anzeige';
    } else {
      colorId = 6;
      colorName = 'DB Fernverkehr';
      description = 'Gemischte DB-Verbindungen';
    }
  } else {
    const netColor = NETWORK_COLORS[dominantNetwork] || NETWORK_COLORS.WL;
    colorId = netColor.id;
    colorName = netColor.name;
    description = `Optimiert für ${NETWORKS[dominantNetwork]?.name || dominantNetwork}`;
  }
  
  // Count total lines
  let totalLines = 0;
  stations.forEach(s => {
    if (s.filter) {
      totalLines += s.filter.split(',').length;
    } else {
      totalLines += 2; // Default assumption
    }
  });
  
  // Suggest rows (max 4, min 1)
  let rows = Math.min(Math.max(Math.ceil(totalLines / stations.length), 1), 4);
  if (totalLines <= 2) rows = totalLines;
  if (rows > 4) rows = 4;
  
  return { color: colorId, colorName, rows, description };
}

function updatePreviewAnimation(suggestion) {
  const previewEl = document.getElementById('previewImage');
  
  // Sample data for preview
  const sampleLines = {
    WL: [
      { badge: 'U1', color: '#E20613', dest: 'Leopoldau', time: '3' },
      { badge: '2', color: '#E20613', dest: 'Ottakring', time: '5' }
    ],
    WLB: [
      { badge: 'WLB', color: '#1E4D8C', dest: 'Baden', time: '4' },
      { badge: 'WLB', color: '#1E4D8C', dest: 'Wien Oper', time: '12' }
    ],
    LINZ: [
      { badge: '3', color: '#009640', dest: 'Universität', time: '2' },
      { badge: '1', color: '#009640', dest: 'Auwiesen', time: '6' }
    ],
    DB_FERN: [
      { badge: 'ICE', color: '#EC0016', dest: 'Berlin Hbf', time: '12' },
      { badge: 'RJ', color: '#EC0016', dest: 'Wien Hbf', time: '28' }
    ],
    DB_SBAHN: [
      { badge: 'S1', color: '#009640', dest: 'Ostbahnhof', time: '3' },
      { badge: 'S7', color: '#009640', dest: 'Ahrensfelde', time: '8' }
    ],
    BERLIN: [
      { badge: 'U5', color: '#7D5E2A', dest: 'Hönow', time: '2' },
      { badge: 'S3', color: '#009640', dest: 'Erkner', time: '5' }
    ],
    BODO: [
      { badge: '7', color: '#005BBB', dest: 'Ravensburg', time: '4' },
      { badge: '1', color: '#005BBB', dest: 'Friedrichshafen', time: '9' }
    ],
    SALZBURG: [
      { badge: '1', color: '#E3000F', dest: 'Maxglan', time: '3' },
      { badge: 'S1', color: '#E3000F', dest: 'Lamprechtshausen', time: '8' }
    ]
  };
  
  // Find matching sample
  let sampleKey = 'WL';
  if (suggestion.color === 4) sampleKey = 'WLB';
  else if (suggestion.color === 2) sampleKey = 'LINZ';
  else if (suggestion.color === 6) sampleKey = 'DB_FERN';
  else if (suggestion.color === 5) sampleKey = 'DB_SBAHN';
  else if (suggestion.color === 3) sampleKey = 'BERLIN';
  else if (suggestion.color === 7) sampleKey = 'BODO';
  else if (suggestion.color === 8) sampleKey = 'SALZBURG';
  
  const lines = sampleLines[sampleKey].slice(0, suggestion.rows);
  
  previewEl.innerHTML = `
    <div class="line-preview">
      ${lines.map((l, i) => `
        <div class="line-row" style="animation-delay: ${i * 0.2}s">
          <span class="line-badge" style="background:${l.color}">${l.badge}</span>
          <span class="line-dest">${l.dest}</span>
          <span class="line-time">${l.time}'</span>
        </div>
      `).join('')}
    </div>
  `;
}

function backFromDisplayConfig() {
  document.getElementById('stepDisplayConfig').classList.add('hidden');
  document.getElementById('stationsCard').classList.remove('hidden');
  document.querySelector('.bottom-bar').style.display = 'block';
}

function showFinetuning() {
  document.getElementById('finetuningSection').classList.toggle('hidden');
}

function sendWithSuggestion() {
  sendConfigToDevice(suggestedColor, suggestedRows);
}

function sendWithCustomConfig() {
  const color = parseInt(document.getElementById('colorSelect').value);
  const rows = parseInt(document.getElementById('rowsSelect').value);
  sendConfigToDevice(color, rows);
}

function sendConfigToDevice(color, rows) {
  const rblString = stations.map(s => s.fullId).join(',');
  const filterString = stations.map(s => s.filter || '').join('|');
  
  console.log('Sending config:', { rbl: rblString, filter: filterString, color, rows });
  
  localStorage.setItem('straba_pending_rbl', rblString);
  localStorage.setItem('straba_pending_filter', filterString);
  localStorage.setItem('straba_pending_color', color);
  localStorage.setItem('straba_pending_rows', rows);
  
  // Send to parent (ESP32)
  if (window.parent && window.parent !== window) {
    window.parent.postMessage({ 
      type: 'setConfig', 
      rbl: rblString, 
      filter: filterString,
      color: color,
      rows: rows
    }, '*');
  }
  
  window.location.href = 'index.html';
}

// Keep old saveConfig for compatibility
function saveConfig() {
  if (stations.length === 0) return;
  
  const rblString = stations.map(s => s.fullId).join(',');
  const filterString = stations.map(s => s.filter || '').join('|');
  
  console.log('Saving:', { rbl: rblString, filter: filterString });
  
  localStorage.setItem('straba_pending_rbl', rblString);
  localStorage.setItem('straba_pending_filter', filterString);
  
  // Send to parent (ESP32)
  if (window.parent && window.parent !== window) {
    window.parent.postMessage({ type: 'setConfig', rbl: rblString, filter: filterString }, '*');
  }
  
  window.location.href = 'index.html';
}

// ==================== LOAD EXISTING ====================
async function loadExistingConfig(rbl, filter) {
  if (!rbl || rbl.trim() === '') return;
  
  const rblParts = rbl.split(',').map(s => s.trim()).filter(s => s);
  const filterParts = filter ? filter.split('|') : [];
  
  for (let idx = 0; idx < rblParts.length; idx++) {
    const part = rblParts[idx];
    let network, stopId;
    
    if (part.includes(':')) {
      [network, stopId] = part.split(':');
    } else {
      network = 'WL';
      stopId = part;
    }
    
    const fullId = `${network}:${stopId}`;
    if (stations.some(s => s.fullId === fullId)) continue;
    
    // Check if it's a journey (has > in stopId)
    const isJourney = stopId.includes('>');
    let stopName = `Station ${stopId}`;
    
    if (isJourney) {
      const [fromId, toId] = stopId.split('>');
      // Try to get names from API
      const fromName = await resolveStationName(network, fromId) || fromId;
      const toName = await resolveStationName(network, toId) || toId;
      stopName = `${fromName} → ${toName}`;
    } else {
      // Try to get name from API
      const resolvedName = await resolveStationName(network, stopId);
      if (resolvedName) {
        stopName = resolvedName;
      }
    }
    
    stations.push({
      network,
      networkName: NETWORKS[network]?.name || network,
      stopId,
      stopName,
      filter: filterParts[idx] || '',
      fullId,
      isJourney,
      isExisting: true
    });
  }
  
  if (stations.length > 0) {
    updateStationsList();
  }
}

// Versucht Stationsnamen von API zu holen
async function resolveStationName(network, stopId) {
  try {
    // Für WL können wir die API nicht so einfach nutzen
    if (network === 'WL') {
      // Versuche aus wienData wenn geladen
      if (wienData) {
        for (const line of wienData) {
          if (!Array.isArray(line.lineStation)) continue;
          for (const item of line.lineStation) {
            if (item.station && String(item.station.stationID) === String(stopId)) {
              return item.station.stationName;
            }
          }
        }
      }
      return null;
    }
    
    // Für externe Netze - Departure API nutzen
    const response = await fetch(`${DEPARTURES_API}?stopId=${network}:${stopId}`);
    const data = await response.json();
    
    if (data.data?.monitors?.[0]?.locationStop?.properties?.title) {
      return data.data.monitors[0].locationStop.properties.title;
    }
    
    return null;
  } catch (e) {
    console.warn(`Could not resolve name for ${network}:${stopId}`);
    return null;
  }
}

// ==================== ESP32 COMMUNICATION ====================
window.addEventListener('message', async function(event) {
  if (event.data?.type === 'loadExistingConfig') {
    // Load Wien data first if any WL stations
    if (event.data.rbl && !event.data.rbl.includes(':')) {
      await loadWienData();
    }
    await loadExistingConfig(event.data.rbl, event.data.filter);
  }
  if (event.data?.type === 'loadFullConfig' && event.data.config?.rbl_id) {
    // Load Wien data first if any WL stations  
    if (event.data.config.rbl_id && !event.data.config.rbl_id.includes(':')) {
      await loadWienData();
    }
    await loadExistingConfig(event.data.config.rbl_id, event.data.config.lines_filter);
  }
});

// ==================== JOURNEY MODE (DB) ====================
let journeyFromTimeout = null;
let journeyToTimeout = null;

function showJourneyFromSelected() {
  const input = document.getElementById('journeyFromInput');
  const results = document.getElementById('journeyFromResults');
  const selected = document.getElementById('journeyFromSelected');
  
  if (journeyFromStop) {
    input.parentElement.classList.add('hidden');
    results.classList.remove('show');
    selected.classList.remove('hidden');
    selected.innerHTML = `
      <span class="station-name">${journeyFromStop.name}</span>
      <button class="change-btn" onclick="clearJourneyFrom()">Ändern</button>
    `;
  }
}

function showJourneyToSelected() {
  const input = document.getElementById('journeyToInput');
  const results = document.getElementById('journeyToResults');
  const selected = document.getElementById('journeyToSelected');
  
  if (journeyToStop) {
    input.parentElement.classList.add('hidden');
    results.classList.remove('show');
    selected.classList.remove('hidden');
    selected.innerHTML = `
      <span class="station-name">${journeyToStop.name}</span>
      <button class="change-btn" onclick="clearJourneyTo()">Ändern</button>
    `;
  }
}

function clearJourneyFrom() {
  journeyFromStop = null;
  selectedProducts = new Set();
  const input = document.getElementById('journeyFromInput');
  const selected = document.getElementById('journeyFromSelected');
  const productsSection = document.getElementById('journeyProductsSection');
  
  input.parentElement.classList.remove('hidden');
  selected.classList.add('hidden');
  if (productsSection) productsSection.classList.add('hidden');
  input.value = '';
  input.focus();
}

function clearJourneyTo() {
  journeyToStop = null;
  selectedProducts = new Set();
  const input = document.getElementById('journeyToInput');
  const selected = document.getElementById('journeyToSelected');
  const productsSection = document.getElementById('journeyProductsSection');
  
  input.parentElement.classList.remove('hidden');
  selected.classList.add('hidden');
  if (productsSection) productsSection.classList.add('hidden');
  input.value = '';
  input.focus();
}

async function performJourneyFromSearch(query) {
  const spinner = document.getElementById('journeyFromSpinner');
  const results = document.getElementById('journeyFromResults');
  
  spinner.classList.add('show');
  
  try {
    const searchResults = await searchViaProxy(selectedNetwork, query);
    displayJourneyResults(searchResults, 'from');
  } catch (e) {
    console.error('Journey search error:', e);
    results.innerHTML = '<div class="no-results">Fehler bei der Suche</div>';
    results.classList.add('show');
  } finally {
    spinner.classList.remove('show');
  }
}

async function performJourneyToSearch(query) {
  const spinner = document.getElementById('journeyToSpinner');
  const results = document.getElementById('journeyToResults');
  
  spinner.classList.add('show');
  
  try {
    const searchResults = await searchViaProxy(selectedNetwork, query);
    displayJourneyResults(searchResults, 'to');
  } catch (e) {
    console.error('Journey search error:', e);
    results.innerHTML = '<div class="no-results">Fehler bei der Suche</div>';
    results.classList.add('show');
  } finally {
    spinner.classList.remove('show');
  }
}

function displayJourneyResults(results, type) {
  const container = document.getElementById(type === 'from' ? 'journeyFromResults' : 'journeyToResults');
  
  if (results.length === 0) {
    container.innerHTML = '<div class="no-results">Keine Stationen gefunden</div>';
  } else {
    container.innerHTML = results.map(r => `
      <div class="search-result-item" onclick="selectJourneyStop('${type}', '${r.id}', '${r.name.replace(/'/g, "\\'")}')">
        <div class="stop-name">${r.name}</div>
        <div class="stop-info">${r.info || `ID: ${r.id}`}</div>
      </div>
    `).join('');
  }
  container.classList.add('show');
}

function selectJourneyStop(type, id, name) {
  if (type === 'from') {
    journeyFromStop = { id, name };
    showJourneyFromSelected();
    // Focus auf "Nach" Feld
    if (!journeyToStop) {
      document.getElementById('journeyToInput').focus();
    }
  } else {
    journeyToStop = { id, name };
    showJourneyToSelected();
  }
  
  // Wenn beide Stationen gewählt, zeige Züge
  if (journeyFromStop && journeyToStop) {
    showProductsInline();
  }
}

function showProductsInline() {
  const section = document.getElementById('journeyProductsSection');
  section.classList.remove('hidden');
  
  selectedProducts = new Set();
  renderProductCategories();
}

function renderProductCategories() {
  const netConfig = NETWORKS[selectedNetwork];
  const categories = netConfig.productCategories || {};
  
  // Domestic
  const domesticContainer = document.getElementById('domesticProducts');
  const domesticProducts = categories.domestic?.products || [];
  domesticContainer.innerHTML = domesticProducts.map(p => renderProductOption(p)).join('');
  
  // International
  const intlContainer = document.getElementById('internationalProducts');
  const intlProducts = categories.international?.products || [];
  intlContainer.innerHTML = intlProducts.map(p => renderProductOption(p)).join('');
  
  updateAddJourneyButton();
}

function renderProductOption(product) {
  const selected = selectedProducts.has(product.id);
  return `
    <div class="product-option ${selected ? 'selected' : ''}" onclick="toggleProduct('${product.id}')">
      <div class="checkbox">${selected ? '✓' : ''}</div>
      <div class="product-badge ${product.id.toLowerCase()}">${product.name}</div>
      <div class="product-name">${product.desc}</div>
    </div>
  `;
}

function toggleCategory(categoryId) {
  const content = document.getElementById(categoryId + 'Products');
  const toggle = document.getElementById(categoryId + 'Toggle');
  
  if (content.classList.contains('collapsed')) {
    content.classList.remove('collapsed');
    toggle.textContent = '▼';
  } else {
    content.classList.add('collapsed');
    toggle.textContent = '▶';
  }
}

function toggleProduct(productId) {
  if (selectedProducts.has(productId)) {
    selectedProducts.delete(productId);
  } else {
    selectedProducts.add(productId);
  }
  renderProductCategories();
}

function updateAddJourneyButton() {
  const btn = document.getElementById('addJourneyBtn');
  if (btn) {
    btn.disabled = selectedProducts.size === 0;
  }
}

function addJourneyStation() {
  if (!journeyFromStop || !journeyToStop || selectedProducts.size === 0) return;
  
  const filter = Array.from(selectedProducts).join(',');
  const fullId = `${selectedNetwork}:${journeyFromStop.id}>${journeyToStop.id}`;
  
  // Check duplicate
  if (stations.some(s => s.fullId === fullId)) {
    alert('Diese Verbindung ist bereits hinzugefügt!');
    return;
  }
  
  stations.push({
    network: selectedNetwork,
    networkName: NETWORKS[selectedNetwork].name,
    stopId: `${journeyFromStop.id}>${journeyToStop.id}`,
    stopName: `${journeyFromStop.name} → ${journeyToStop.name}`,
    filter: filter,
    fullId: fullId,
    isJourney: true,
    isExisting: false
  });
  
  // Reset
  journeyFromStop = null;
  journeyToStop = null;
  selectedProducts = new Set();
  
  // Hide products section
  document.getElementById('journeyProductsSection').classList.add('hidden');
  
  goBack('region');
  updateStationsList();
}

// ==================== INIT ====================
window.addEventListener('DOMContentLoaded', () => {
  if (window.parent && window.parent !== window) {
    window.parent.postMessage({ type: 'requestExistingConfig' }, '*');
    window.parent.postMessage({ type: 'requestFullConfig' }, '*');
  }
  
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
      searchResults.classList.remove('show');
    }
    
    // Close journey search results when clicking outside
    const fromInput = document.getElementById('journeyFromInput');
    const fromResults = document.getElementById('journeyFromResults');
    const toInput = document.getElementById('journeyToInput');
    const toResults = document.getElementById('journeyToResults');
    
    if (fromInput && fromResults && !fromInput.contains(e.target) && !fromResults.contains(e.target)) {
      fromResults.classList.remove('show');
    }
    if (toInput && toResults && !toInput.contains(e.target) && !toResults.contains(e.target)) {
      toResults.classList.remove('show');
    }
  });
  
  // Journey From Input
  const journeyFromInput = document.getElementById('journeyFromInput');
  if (journeyFromInput) {
    journeyFromInput.addEventListener('input', function() {
      const query = this.value.trim();
      if (journeyFromTimeout) clearTimeout(journeyFromTimeout);
      
      if (query.length < 2) {
        document.getElementById('journeyFromResults').classList.remove('show');
        return;
      }
      
      journeyFromTimeout = setTimeout(() => performJourneyFromSearch(query), 300);
    });
  }
  
  // Journey To Input
  const journeyToInput = document.getElementById('journeyToInput');
  if (journeyToInput) {
    journeyToInput.addEventListener('input', function() {
      const query = this.value.trim();
      if (journeyToTimeout) clearTimeout(journeyToTimeout);
      
      if (query.length < 2) {
        document.getElementById('journeyToResults').classList.remove('show');
        return;
      }
      
      journeyToTimeout = setTimeout(() => performJourneyToSearch(query), 300);
    });
  }
});
</script>

</body>
</html>
