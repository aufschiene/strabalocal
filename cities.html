<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Straba St√§dte</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      min-height: 100vh;
      color: #fff;
      padding: 20px;
      padding-bottom: 120px;
    }
    
    .container {
      max-width: 500px;
      margin: 0 auto;
    }
    
    .header {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .header h1 {
      font-size: 24px;
      margin-bottom: 8px;
      color: #fff;
    }
    
    .header p {
      color: #aaa;
      font-size: 14px;
    }
    
    /* Cards */
    .card {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .card h2 {
      font-size: 16px;
      color: #ffd700;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card h2 .step {
      background: #ffd700;
      color: #1a1a2e;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    /* Existing Config Banner */
    .existing-banner {
      background: linear-gradient(135deg, rgba(56, 239, 125, 0.2), rgba(17, 153, 142, 0.2));
      border: 1px solid rgba(56, 239, 125, 0.4);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 16px;
      display: none;
    }
    
    .existing-banner.show {
      display: block;
    }
    
    .existing-banner .title {
      font-weight: 600;
      color: #38ef7d;
      margin-bottom: 4px;
      font-size: 14px;
    }
    
    .existing-banner .text {
      color: #aaa;
      font-size: 12px;
    }
    
    /* Network Grid */
    .network-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .network-btn {
      padding: 14px 12px;
      border-radius: 12px;
      border: 2px solid rgba(255, 255, 255, 0.15);
      background: rgba(0, 0, 0, 0.2);
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }
    
    .network-btn:hover {
      border-color: rgba(255, 215, 0, 0.4);
      background: rgba(255, 215, 0, 0.1);
    }
    
    .network-btn.active {
      border-color: #ffd700;
      background: rgba(255, 215, 0, 0.15);
    }
    
    .network-btn .flag {
      font-size: 20px;
      margin-bottom: 4px;
    }
    
    .network-btn .name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }
    
    .network-btn .region {
      font-size: 11px;
      color: #888;
    }
    
    /* Search Input */
    .search-container {
      position: relative;
      margin-bottom: 16px;
    }
    
    .search-input {
      width: 100%;
      padding: 16px 16px 16px 48px;
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 14px;
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 16px;
      transition: all 0.2s;
    }
    
    .search-input:focus {
      outline: none;
      border-color: #ffd700;
      background: rgba(0, 0, 0, 0.5);
    }
    
    .search-input::placeholder {
      color: #666;
    }
    
    .search-input:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      color: #666;
    }
    
    .search-spinner {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255, 215, 0, 0.3);
      border-top-color: #ffd700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }
    
    .search-spinner.show {
      display: block;
    }
    
    @keyframes spin {
      to { transform: translateY(-50%) rotate(360deg); }
    }
    
    /* Search Results Dropdown */
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #1e1e3f;
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      margin-top: 4px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }
    
    .search-results.show {
      display: block;
    }
    
    .search-result-item {
      padding: 14px 16px;
      cursor: pointer;
      transition: all 0.15s;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .search-result-item:last-child {
      border-bottom: none;
    }
    
    .search-result-item:hover {
      background: rgba(255, 215, 0, 0.1);
    }
    
    .search-result-item .stop-name {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }
    
    .search-result-item .stop-info {
      font-size: 12px;
      color: #888;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .search-result-item .stop-id {
      background: rgba(255, 255, 255, 0.1);
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 11px;
    }
    
    .no-results {
      padding: 20px;
      text-align: center;
      color: #888;
    }
    
    /* Filter Input */
    .filter-section {
      display: none;
      margin-top: 16px;
      padding: 16px;
      background: rgba(255, 215, 0, 0.1);
      border-radius: 12px;
      border: 1px solid rgba(255, 215, 0, 0.3);
    }
    
    .filter-section.show {
      display: block;
    }
    
    .filter-section h3 {
      font-size: 14px;
      color: #ffd700;
      margin-bottom: 8px;
    }
    
    .filter-section .selected-stop {
      font-size: 13px;
      color: #aaa;
      margin-bottom: 12px;
    }
    
    .filter-section .selected-stop strong {
      color: #fff;
    }
    
    .filter-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 14px;
    }
    
    .filter-input:focus {
      outline: none;
      border-color: #ffd700;
    }
    
    .filter-input::placeholder {
      color: #666;
    }
    
    .filter-hint {
      font-size: 11px;
      color: #888;
      margin-top: 6px;
    }
    
    /* Station Chips */
    .stations-container {
      margin-top: 12px;
    }
    
    .station-chip {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(56, 239, 125, 0.15);
      border: 1px solid rgba(56, 239, 125, 0.3);
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 10px;
    }
    
    .station-chip.existing {
      background: rgba(255, 215, 0, 0.1);
      border-color: rgba(255, 215, 0, 0.3);
    }
    
    .station-chip .network-badge {
      background: #ffd700;
      color: #1a1a2e;
      padding: 4px 10px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
      flex-shrink: 0;
    }
    
    .station-chip .info {
      flex: 1;
      min-width: 0;
    }
    
    .station-chip .stop-name {
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .station-chip .stop-details {
      font-size: 12px;
      color: #888;
      margin-top: 2px;
    }
    
    .station-chip .delete {
      background: rgba(255, 107, 107, 0.2);
      border: none;
      color: #ff6b6b;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    
    .station-chip .delete:hover {
      background: rgba(255, 107, 107, 0.4);
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 30px;
      color: #666;
    }
    
    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 12px;
    }
    
    /* Buttons */
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .btn-add {
      background: linear-gradient(135deg, #11998e, #38ef7d);
      color: #fff;
      margin-top: 12px;
    }
    
    .btn-add:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(56, 239, 125, 0.3);
    }
    
    .btn-add:disabled {
      background: #444;
      color: #777;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .btn-test {
      background: rgba(255, 255, 255, 0.15);
      color: #fff;
      margin-top: 12px;
    }
    
    .btn-test:hover {
      background: rgba(255, 255, 255, 0.25);
    }
    
    .btn-test:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }
    
    /* Bottom Bar */
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(26, 26, 46, 0.98);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      padding: 16px 20px;
      backdrop-filter: blur(10px);
    }
    
    .bottom-bar .container {
      max-width: 500px;
    }
    
    .btn-primary {
      background: #ffd700;
      color: #1a1a2e;
    }
    
    .btn-primary:hover {
      background: #ffed4a;
      transform: translateY(-1px);
    }
    
    .btn-primary:disabled {
      background: #555;
      color: #888;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Test Results */
    .test-results {
      margin-top: 16px;
      display: none;
    }
    
    .test-results.show {
      display: block;
    }
    
    .test-results .status {
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
      font-size: 14px;
    }
    
    .test-results .status.success {
      background: rgba(56, 239, 125, 0.2);
      border: 1px solid rgba(56, 239, 125, 0.4);
      color: #38ef7d;
    }
    
    .test-results .status.error {
      background: rgba(255, 107, 107, 0.2);
      border: 1px solid rgba(255, 107, 107, 0.4);
      color: #ff6b6b;
    }
    
    .test-results .status.loading {
      background: rgba(255, 215, 0, 0.2);
      border: 1px solid rgba(255, 215, 0, 0.4);
      color: #ffd700;
    }
    
    .results-box {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 14px;
      max-height: 250px;
      overflow-y: auto;
    }
    
    .departure-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .departure-item:last-child {
      border-bottom: none;
    }
    
    .departure-item .line {
      background: #ffd700;
      color: #1a1a2e;
      padding: 4px 10px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 14px;
      min-width: 50px;
      text-align: center;
    }
    
    .departure-item .towards {
      flex: 1;
      color: #aaa;
      font-size: 13px;
    }
    
    .departure-item .time {
      font-weight: 600;
      font-size: 15px;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(26, 26, 46, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 1000;
    }
    
    .loading-overlay.show {
      display: flex;
    }
    
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid rgba(255, 215, 0, 0.3);
      border-top-color: #ffd700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 16px;
    }
    
    .loading-text {
      color: #fff;
      font-size: 16px;
    }
    
    /* Info Box */
    .info-box {
      background: rgba(255, 215, 0, 0.08);
      border: 1px solid rgba(255, 215, 0, 0.2);
      border-radius: 12px;
      padding: 14px;
      margin-top: 16px;
    }
    
    .info-box p {
      color: #aaa;
      font-size: 13px;
      line-height: 1.5;
    }
    
    .info-box strong {
      color: #ffd700;
    }
  </style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div class="loading-text" id="loadingText">Speichere...</div>
</div>

<div class="container">
  <div class="header">
    <h1>üåç St√§dte & Netze</h1>
    <p>W√§hle Stationen aus verschiedenen Verkehrsnetzen</p>
  </div>
  
  <!-- Existing Config Banner -->
  <div class="existing-banner" id="existingBanner">
    <div class="title">‚úì Bestehende Konfiguration geladen</div>
    <div class="text">Du kannst weitere Stationen hinzuf√ºgen oder bestehende entfernen.</div>
  </div>
  
  <!-- Step 1: Network Selection -->
  <div class="card">
    <h2><span class="step">1</span> Netzwerk w√§hlen</h2>
    
    <div class="network-grid" id="networkGrid">
      <button class="network-btn" data-network="WL" onclick="selectNetwork('WL')">
        <div class="flag">üá¶üáπ</div>
        <div class="name">Wiener Linien</div>
        <div class="region">Wien</div>
      </button>
      <button class="network-btn" data-network="LINZ" onclick="selectNetwork('LINZ')">
        <div class="flag">üá¶üáπ</div>
        <div class="name">Linz AG</div>
        <div class="region">Linz</div>
      </button>
      <button class="network-btn" data-network="BODO" onclick="selectNetwork('BODO')">
        <div class="flag">üá©üá™</div>
        <div class="name">BODO</div>
        <div class="region">Ulm / Bodensee</div>
      </button>
      <button class="network-btn" data-network="BERLIN" onclick="selectNetwork('BERLIN')">
        <div class="flag">üá©üá™</div>
        <div class="name">VBB</div>
        <div class="region">Berlin</div>
      </button>
      <button class="network-btn" data-network="DB" onclick="selectNetwork('DB')">
        <div class="flag">üá©üá™</div>
        <div class="name">Deutsche Bahn</div>
        <div class="region">ganz Deutschland</div>
      </button>
    </div>
  </div>
  
  <!-- Step 2: Search Station -->
  <div class="card" id="searchCard" style="opacity: 0.5; pointer-events: none;">
    <h2><span class="step">2</span> Station suchen</h2>
    
    <div class="search-container">
      <span class="search-icon">üîç</span>
      <input type="text" class="search-input" id="searchInput" placeholder="Stationsname eingeben..." disabled autocomplete="off">
      <div class="search-spinner" id="searchSpinner"></div>
      <div class="search-results" id="searchResults"></div>
    </div>
    
    <!-- Filter Section (shows after station selected) -->
    <div class="filter-section" id="filterSection">
      <h3>Ausgew√§hlte Station:</h3>
      <div class="selected-stop" id="selectedStopInfo"></div>
      
      <input type="text" class="filter-input" id="filterInput" placeholder="z.B. U1,U2,37A oder leer f√ºr alle">
      <div class="filter-hint">Komma-getrennt. Leer = alle Linien anzeigen</div>
      
      <button class="btn btn-add" id="addBtn" onclick="addStation()">
        ‚ûï Station hinzuf√ºgen
      </button>
    </div>
  </div>
  
  <!-- Step 3: Added Stations -->
  <div class="card">
    <h2><span class="step">3</span> Deine Stationen (<span id="stationCount">0</span>)</h2>
    
    <div class="stations-container" id="stationsContainer">
      <div class="empty-state" id="emptyState">
        <div class="icon">üöè</div>
        <p>Noch keine Stationen hinzugef√ºgt</p>
      </div>
    </div>
    
    <button class="btn btn-test" id="testBtn" onclick="testStations()" disabled>
      üîç Verbindung testen
    </button>
    
    <div class="test-results" id="testResults">
      <div class="status" id="testStatus"></div>
      <div class="results-box" id="resultsBox"></div>
    </div>
    
    <div class="info-box">
      <p>üí° <strong>Tipp:</strong> Du kannst Stationen aus verschiedenen Netzen kombinieren!</p>
    </div>
  </div>
</div>

<!-- Bottom Bar -->
<div class="bottom-bar">
  <div class="container">
    <button class="btn btn-primary" id="saveBtn" onclick="saveConfig()" disabled>
      Weiter zu den Einstellungen
    </button>
  </div>
</div>

<script>
// ==================== NETWORK CONFIGS ====================
const NETWORKS = {
  WL: {
    name: 'Wiener Linien',
    searchType: 'wien_json',
    placeholder: 'z.B. Karlsplatz, Westbahnhof...'
  },
  LINZ: {
    name: 'Linz AG',
    searchType: 'server_proxy',
    placeholder: 'z.B. Hauptbahnhof, Taubenmarkt...'
  },
  BODO: {
    name: 'BODO',
    searchType: 'server_proxy',
    placeholder: 'z.B. Ulm Hauptbahnhof...'
  },
  BERLIN: {
    name: 'VBB Berlin',
    searchType: 'server_proxy',
    placeholder: 'z.B. Alexanderplatz, Hauptbahnhof...'
  },
  DB: {
    name: 'Deutsche Bahn',
    searchType: 'server_proxy',
    placeholder: 'z.B. Berlin Hbf, M√ºnchen...'
  }
};

// Server proxy URL
const SEARCH_API = 'https://api.straba.at/api/v1/stops/search';
const WIEN_DATA_URL = 'https://straba-983965425140.europe-west3.run.app/search/';

// ==================== STATE ====================
let selectedNetwork = null;
let selectedStop = null;
let stations = [];
let searchTimeout = null;
let wienData = null; // Cache f√ºr Wien-Daten

// ==================== DOM ELEMENTS ====================
const searchCard = document.getElementById('searchCard');
const searchInput = document.getElementById('searchInput');
const searchSpinner = document.getElementById('searchSpinner');
const searchResults = document.getElementById('searchResults');
const filterSection = document.getElementById('filterSection');
const filterInput = document.getElementById('filterInput');
const selectedStopInfo = document.getElementById('selectedStopInfo');
const addBtn = document.getElementById('addBtn');
const stationsContainer = document.getElementById('stationsContainer');
const emptyState = document.getElementById('emptyState');
const stationCount = document.getElementById('stationCount');
const testBtn = document.getElementById('testBtn');
const testResults = document.getElementById('testResults');
const testStatus = document.getElementById('testStatus');
const resultsBox = document.getElementById('resultsBox');
const saveBtn = document.getElementById('saveBtn');
const existingBanner = document.getElementById('existingBanner');
const loadingOverlay = document.getElementById('loadingOverlay');
const loadingText = document.getElementById('loadingText');

// ==================== NETWORK SELECTION ====================
function selectNetwork(network) {
  selectedNetwork = network;
  selectedStop = null;
  
  // Update UI
  document.querySelectorAll('.network-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.network === network);
  });
  
  // Enable search
  searchCard.style.opacity = '1';
  searchCard.style.pointerEvents = 'auto';
  searchInput.disabled = false;
  searchInput.placeholder = NETWORKS[network].placeholder;
  searchInput.value = '';
  searchInput.focus();
  
  // Hide filter section
  filterSection.classList.remove('show');
  searchResults.classList.remove('show');
  
  // Load Wien data if needed
  if (network === 'WL' && !wienData) {
    loadWienData();
  }
}

// ==================== WIEN DATA LOADER ====================
async function loadWienData() {
  try {
    const response = await fetch(WIEN_DATA_URL);
    wienData = await response.json();
    console.log('Wien data loaded:', wienData.length, 'lines');
  } catch (e) {
    console.error('Failed to load Wien data:', e);
  }
}

// ==================== SEARCH ====================
searchInput.addEventListener('input', function() {
  const query = this.value.trim();
  
  // Clear previous timeout
  if (searchTimeout) {
    clearTimeout(searchTimeout);
  }
  
  // Hide results if empty
  if (query.length < 2) {
    searchResults.classList.remove('show');
    return;
  }
  
  // Debounce search
  searchTimeout = setTimeout(() => {
    performSearch(query);
  }, 300);
});

searchInput.addEventListener('focus', function() {
  if (this.value.trim().length >= 2) {
    searchResults.classList.add('show');
  }
});

async function performSearch(query) {
  if (!selectedNetwork) return;
  
  const config = NETWORKS[selectedNetwork];
  searchSpinner.classList.add('show');
  
  try {
    let results = [];
    
    if (config.searchType === 'wien_json') {
      results = searchWien(query);
    } else if (config.searchType === 'server_proxy') {
      results = await searchViaProxy(selectedNetwork, query);
    }
    
    displaySearchResults(results);
  } catch (e) {
    console.error('Search error:', e);
    searchResults.innerHTML = '<div class="no-results">Fehler bei der Suche</div>';
    searchResults.classList.add('show');
  } finally {
    searchSpinner.classList.remove('show');
  }
}

// Search via Server Proxy (LINZ, BODO, BERLIN, DB)
async function searchViaProxy(network, query) {
  const params = new URLSearchParams({
    network: network,
    q: query
  });
  
  const response = await fetch(`${SEARCH_API}?${params}`);
  const data = await response.json();
  
  if (data.error) {
    console.error('Proxy error:', data.error);
    return [];
  }
  
  return (data.stops || []).map(s => ({
    id: s.id,
    name: s.name,
    info: s.info || ''
  }));
}

// Wien: Local search in cached data
function searchWien(query) {
  if (!wienData) return [];
  
  const q = query.toLowerCase();
  const stationsMap = new Map();
  
  wienData.forEach(line => {
    if (!Array.isArray(line.lineStation)) return;
    
    line.lineStation.forEach(item => {
      const station = item.station;
      if (!station || !station.stationName || !station.stationID) return;
      
      if (station.stationName.toLowerCase().includes(q)) {
        const id = station.stationID;
        if (!stationsMap.has(id)) {
          stationsMap.set(id, {
            id: String(id),
            name: station.stationName,
            lines: new Set()
          });
        }
        stationsMap.get(id).lines.add(line.lineName);
      }
    });
  });
  
  return Array.from(stationsMap.values())
    .map(s => ({
      id: s.id,
      name: s.name,
      info: Array.from(s.lines).slice(0, 5).join(', ') + (s.lines.size > 5 ? '...' : '')
    }))
    .slice(0, 15);
}

function displaySearchResults(results) {
  if (results.length === 0) {
    searchResults.innerHTML = '<div class="no-results">Keine Stationen gefunden</div>';
  } else {
    searchResults.innerHTML = results.map(r => `
      <div class="search-result-item" onclick="selectStop('${r.id}', '${r.name.replace(/'/g, "\\'")}')">
        <div class="stop-name">${r.name}</div>
        <div class="stop-info">
          <span class="stop-id">${r.id}</span>
          ${r.info ? `<span>${r.info}</span>` : ''}
        </div>
      </div>
    `).join('');
  }
  
  searchResults.classList.add('show');
}

// ==================== STOP SELECTION ====================
function selectStop(id, name) {
  selectedStop = { id, name };
  
  // Update UI
  searchInput.value = name;
  searchResults.classList.remove('show');
  
  // Show filter section
  selectedStopInfo.innerHTML = `<strong>${name}</strong><br>ID: ${id}`;
  filterInput.value = '';
  filterSection.classList.add('show');
}

// ==================== ADD STATION ====================
function addStation() {
  if (!selectedNetwork || !selectedStop) return;
  
  const filter = filterInput.value.trim();
  const fullId = `${selectedNetwork}:${selectedStop.id}`;
  
  // Check for duplicates
  if (stations.some(s => s.fullId === fullId)) {
    alert('Diese Station ist bereits hinzugef√ºgt!');
    return;
  }
  
  stations.push({
    network: selectedNetwork,
    networkName: NETWORKS[selectedNetwork].name,
    stopId: selectedStop.id,
    stopName: selectedStop.name,
    filter: filter,
    fullId: fullId,
    isExisting: false
  });
  
  // Reset selection
  selectedStop = null;
  searchInput.value = '';
  filterInput.value = '';
  filterSection.classList.remove('show');
  
  updateStationsList();
}

function removeStation(index) {
  stations.splice(index, 1);
  updateStationsList();
}

function updateStationsList() {
  stationCount.textContent = stations.length;
  
  if (stations.length === 0) {
    emptyState.style.display = 'block';
    testBtn.disabled = true;
    saveBtn.disabled = true;
  } else {
    emptyState.style.display = 'none';
    testBtn.disabled = false;
    saveBtn.disabled = false;
  }
  
  // Render chips
  const chips = stations.map((s, idx) => `
    <div class="station-chip${s.isExisting ? ' existing' : ''}">
      <span class="network-badge">${s.network}</span>
      <div class="info">
        <div class="stop-name">${s.stopName}</div>
        <div class="stop-details">
          ID: ${s.stopId}${s.filter ? ` ¬∑ Filter: ${s.filter}` : ''}
        </div>
      </div>
      <button class="delete" onclick="removeStation(${idx})">‚úï</button>
    </div>
  `).join('');
  
  // Insert before empty state
  const existingChips = stationsContainer.querySelectorAll('.station-chip');
  existingChips.forEach(c => c.remove());
  emptyState.insertAdjacentHTML('beforebegin', chips);
  
  // Hide test results
  testResults.classList.remove('show');
}

// ==================== TEST API ====================
async function testStations() {
  if (stations.length === 0) return;
  
  testResults.classList.add('show');
  testStatus.className = 'status loading';
  testStatus.textContent = '‚è≥ Teste Verbindung...';
  resultsBox.innerHTML = '';
  
  const stopIds = stations.map(s => s.fullId).join(',');
  const url = `https://api.straba.at/api/v1/wl/departures?stopId=${stopIds}`;
  
  try {
    const response = await fetch(url);
    const data = await response.json();
    
    if (data.data && data.data.monitors && data.data.monitors.length > 0) {
      testStatus.className = 'status success';
      testStatus.textContent = `‚úÖ OK - ${data.data.monitors.length} Station(en) gefunden`;
      
      let html = '';
      data.data.monitors.forEach(monitor => {
        const title = monitor.locationStop?.properties?.title || 'Station';
        html += `<div style="color:#ffd700;font-weight:600;margin:10px 0 6px 0;">${title}</div>`;
        
        const lines = monitor.lines || [];
        if (lines.length === 0) {
          html += '<div style="color:#888;font-size:13px;padding:8px 0;">Keine Abfahrten</div>';
        } else {
          lines.slice(0, 5).forEach(line => {
            const dep = line.departures?.departure?.[0];
            const countdown = dep?.departureTime?.countdown;
            html += `
              <div class="departure-item">
                <span class="line">${line.name || '?'}</span>
                <span class="towards">${line.towards || ''}</span>
                <span class="time">${countdown !== undefined ? countdown + "'" : '?'}</span>
              </div>
            `;
          });
        }
      });
      
      resultsBox.innerHTML = html;
    } else {
      testStatus.className = 'status error';
      testStatus.textContent = '‚ö†Ô∏è Keine Daten - Stop ID pr√ºfen!';
    }
  } catch (e) {
    testStatus.className = 'status error';
    testStatus.textContent = '‚ùå Fehler: ' + e.message;
  }
}

// ==================== SAVE CONFIG ====================
function saveConfig() {
  if (stations.length === 0) return;
  
  // Build RBL string
  const rblString = stations.map(s => s.fullId).join(',');
  
  // Build filter string
  const filterString = stations.map(s => s.filter || '').join('|');
  
  // Build details for index.html
  const details = stations.map(s => ({
    id: s.fullId,
    name: s.stopName,
    lines: s.filter ? s.filter.split(',').map(f => ({ name: f.trim(), direction: '' })) : []
  }));
  
  console.log('Speichere:', { rbl: rblString, filter: filterString });
  
  // Save to localStorage
  localStorage.setItem('straba_pending_rbl', rblString);
  localStorage.setItem('straba_pending_filter', filterString);
  localStorage.setItem('straba_pending_details', JSON.stringify(details));
  
  // Navigate to index.html
  window.location.href = 'index.html';
}

// ==================== LOAD EXISTING CONFIG ====================
function loadExistingConfig(rbl, filter) {
  if (!rbl || rbl.trim() === '') return;
  
  console.log('Lade bestehende Config:', rbl, filter);
  
  const rblParts = rbl.split(',').map(s => s.trim()).filter(s => s);
  const filterParts = filter ? filter.split('|') : [];
  
  rblParts.forEach((part, idx) => {
    let network, stopId;
    
    if (part.includes(':')) {
      [network, stopId] = part.split(':');
    } else {
      network = 'WL';
      stopId = part;
    }
    
    const fullId = `${network}:${stopId}`;
    
    if (stations.some(s => s.fullId === fullId)) return;
    
    stations.push({
      network,
      networkName: NETWORKS[network]?.name || network,
      stopId,
      stopName: `Station ${stopId}`,
      filter: filterParts[idx] || '',
      fullId,
      isExisting: true
    });
  });
  
  if (stations.length > 0) {
    existingBanner.classList.add('show');
    updateStationsList();
  }
}

// ==================== ESP32 COMMUNICATION ====================
window.addEventListener('message', function(event) {
  console.log('Message from parent:', event.data);
  
  if (event.data && event.data.type === 'loadExistingConfig') {
    loadExistingConfig(event.data.rbl, event.data.filter);
  }
  
  if (event.data && event.data.type === 'loadFullConfig') {
    const config = event.data.config;
    if (config && config.rbl_id) {
      loadExistingConfig(config.rbl_id, config.lines_filter);
    }
  }
});

// ==================== INIT ====================
window.addEventListener('DOMContentLoaded', () => {
  // Request config from parent
  if (window.parent && window.parent !== window) {
    window.parent.postMessage({ type: 'requestExistingConfig' }, '*');
    window.parent.postMessage({ type: 'requestFullConfig' }, '*');
  }
  
  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
      searchResults.classList.remove('show');
    }
  });
});
</script>

</body>
</html>
