<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Straba St√§dte</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
      color: #333;
      padding: 20px;
      padding-bottom: 120px;
    }
    
    .container { max-width: 500px; margin: 0 auto; }
    
    .header {
      text-align: center;
      margin-bottom: 24px;
    }
    .header h1 { font-size: 24px; margin-bottom: 8px; color: #333; }
    .header p { color: #666; font-size: 14px; }
    
    /* Breadcrumb */
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
      font-size: 13px;
      flex-wrap: wrap;
    }
    .breadcrumb-item {
      color: #888;
      cursor: pointer;
      transition: color 0.2s;
    }
    .breadcrumb-item:hover { color: #0055a4; }
    .breadcrumb-item.active { color: #0055a4; font-weight: 600; cursor: default; }
    .breadcrumb-sep { color: #ccc; }
    
    /* Cards */
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      border: 1px solid #e0e0e0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .card h2 {
      font-size: 16px;
      color: #333;
      margin-bottom: 16px;
    }
    
    /* Selection Grid */
    .selection-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .selection-grid.single { grid-template-columns: 1fr; }
    
    .selection-btn {
      padding: 16px;
      border-radius: 12px;
      border: 2px solid #e0e0e0;
      background: #fff;
      color: #333;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    .selection-btn:hover {
      border-color: #0055a4;
      background: #f0f5fa;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .selection-btn .icon { font-size: 32px; margin-bottom: 8px; }
    .selection-btn .name { font-weight: 600; font-size: 15px; margin-bottom: 4px; color: #333; }
    .selection-btn .desc { font-size: 11px; color: #888; }
    .selection-btn.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    .selection-btn.disabled:hover {
      border-color: #e0e0e0;
      background: #fff;
      transform: none;
      box-shadow: none;
    }
    
    /* Search */
    .search-container { position: relative; margin-bottom: 16px; }
    .search-input {
      width: 100%;
      padding: 16px 16px 16px 48px;
      border: 2px solid #e0e0e0;
      border-radius: 14px;
      background: #fff;
      color: #333;
      font-size: 16px;
      transition: all 0.2s;
    }
    .search-input:focus {
      outline: none;
      border-color: #0055a4;
      box-shadow: 0 0 0 3px rgba(0, 85, 164, 0.1);
    }
    .search-input::placeholder { color: #999; }
    .search-icon {
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      color: #999;
    }
    .search-spinner {
      position: absolute;
      right: 16px;
      top: 50%;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      border: 2px solid rgba(0, 85, 164, 0.3);
      border-top-color: #0055a4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: none;
    }
    .search-spinner.show { display: block; }
    @keyframes spin { to { transform: translateY(-50%) rotate(360deg); } }
    
    /* Search Results */
    .search-results {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      max-height: 300px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .search-results.show { display: block; }
    .search-result-item {
      padding: 14px 16px;
      cursor: pointer;
      transition: all 0.15s;
      border-bottom: 1px solid #f0f0f0;
    }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:hover { background: #f8f8f8; }
    .search-result-item .stop-name { font-weight: 600; font-size: 15px; margin-bottom: 4px; color: #333; }
    .search-result-item .stop-info { font-size: 12px; color: #888; }
    .no-results { padding: 20px; text-align: center; color: #888; }
    
    /* Lines Selection */
    .lines-container { margin-top: 16px; }
    .lines-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .lines-header h3 { font-size: 14px; color: #333; }
    .select-all-btn {
      font-size: 12px;
      color: #0055a4;
      background: none;
      border: none;
      cursor: pointer;
    }
    
    .line-group {
      margin-bottom: 16px;
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
    }
    .line-group-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      background: #f8f8f8;
      border-bottom: 1px solid #e0e0e0;
    }
    .line-group-header .line-badge {
      padding: 6px 14px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 15px;
      min-width: 50px;
      text-align: center;
    }
    /* Tram/Stra√üenbahn - Rot */
    .line-badge.type-tram {
      background: #c41e3a;
      color: #fff;
    }
    /* Bus - Blau */
    .line-badge.type-bus {
      background: #0055a4;
      color: #fff;
    }
    /* U-Bahn - Schwarz mit wei√üer Schrift */
    .line-badge.type-metro {
      background: #1a1a1a;
      color: #fff;
    }
    /* S-Bahn - Gr√ºn */
    .line-badge.type-suburban {
      background: #006e34;
      color: #fff;
    }
    /* Regional/Zug - Wei√ü mit schwarzer Schrift */
    .line-badge.type-train {
      background: #fff;
      color: #1a1a1a;
      border: 2px solid #1a1a1a;
    }
    /* Default */
    .line-badge.type-default {
      background: #666;
      color: #fff;
    }
    
    .line-group-header .line-name {
      font-weight: 600;
      font-size: 14px;
      color: #333;
    }
    .line-group-header .line-toggle {
      margin-left: auto;
      font-size: 12px;
      color: #0055a4;
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
    }
    .line-group-header .line-toggle:hover {
      text-decoration: underline;
    }
    
    .line-directions {
      padding: 4px 0;
    }
    
    .direction-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .direction-option:hover {
      background: #f8f8f8;
    }
    .direction-option.selected {
      background: #e8f5e9;
    }
    .direction-option .checkbox {
      width: 22px;
      height: 22px;
      border: 2px solid #ccc;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
      transition: all 0.15s;
    }
    .direction-option.selected .checkbox {
      background: #4caf50;
      border-color: #4caf50;
      color: #fff;
    }
    .direction-option .direction-text {
      font-size: 14px;
      color: #555;
    }
    .direction-option .direction-text::before {
      content: '‚Üí ';
      color: #999;
    }
    
    .lines-loading {
      text-align: center;
      padding: 30px;
      color: #888;
    }
    .lines-loading .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid #e0e0e0;
      border-top-color: #0055a4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    
    /* Station Chips */
    .station-chip {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #e8f5e9;
      border: 1px solid #a5d6a7;
      border-radius: 12px;
      padding: 12px 14px;
      margin-bottom: 10px;
    }
    .station-chip.existing {
      background: #fff8e1;
      border-color: #ffe082;
    }
    .station-chip .network-badge {
      background: #333;
      color: #fff;
      padding: 4px 10px;
      border-radius: 8px;
      font-weight: 700;
      font-size: 12px;
      flex-shrink: 0;
    }
    .station-chip .info { flex: 1; min-width: 0; }
    .station-chip .stop-name {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .station-chip .stop-details { font-size: 12px; color: #666; margin-top: 2px; }
    .station-chip .delete {
      background: #ffebee;
      border: none;
      color: #c62828;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .station-chip .delete:hover { background: #ffcdd2; }
    
    .empty-state {
      text-align: center;
      padding: 30px;
      color: #999;
    }
    .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
    
    /* Buttons */
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .btn-primary {
      background: #4caf50;
      color: #fff;
    }
    .btn-primary:hover {
      background: #43a047;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
    }
    .btn-primary:disabled {
      background: #e0e0e0;
      color: #999;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
      margin-top: 12px;
    }
    .btn-secondary:hover { background: #e0e0e0; }
    
    /* Bottom Bar */
    .bottom-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      padding: 16px 20px;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
    }
    .bottom-bar .container { max-width: 500px; }
    .btn-save {
      background: #0055a4;
      color: #fff;
    }
    .btn-save:hover { background: #004080; }
    .btn-save:disabled { background: #e0e0e0; color: #999; cursor: not-allowed; }
    
    /* Back Button */
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      color: #666;
      font-size: 14px;
      background: none;
      border: none;
      cursor: pointer;
      margin-bottom: 16px;
      padding: 8px 0;
    }
    .back-btn:hover { color: #0055a4; }
    
    /* Hidden */
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>üåç St√§dte & Netze</h1>
    <p>W√§hle Stationen aus verschiedenen Verkehrsnetzen</p>
  </div>
  
  <!-- Breadcrumb -->
  <div class="breadcrumb" id="breadcrumb">
    <span class="breadcrumb-item active">Region w√§hlen</span>
  </div>
  
  <!-- Step 1: Region -->
  <div class="card" id="stepRegion">
    <h2>Region w√§hlen</h2>
    <div class="selection-grid">
      <button class="selection-btn" onclick="selectRegion('AT')">
        <div class="icon">üá¶üáπ</div>
        <div class="name">√ñsterreich</div>
        <div class="desc">Wien, Linz</div>
      </button>
      <button class="selection-btn" onclick="selectRegion('DE')">
        <div class="icon">üá©üá™</div>
        <div class="name">Deutschland</div>
        <div class="desc">DB, Berlin, Ulm</div>
      </button>
      <button class="selection-btn disabled" onclick="selectRegion('CH')">
        <div class="icon">üá®üá≠</div>
        <div class="name">Schweiz</div>
        <div class="desc">Bald verf√ºgbar</div>
      </button>
      <button class="selection-btn disabled" onclick="selectRegion('DK')">
        <div class="icon">üá©üá∞</div>
        <div class="name">D√§nemark</div>
        <div class="desc">Bald verf√ºgbar</div>
      </button>
    </div>
  </div>
  
  <!-- Step 2: Network -->
  <div class="card hidden" id="stepNetwork">
    <button class="back-btn" onclick="goBack('region')">‚Üê Zur√ºck</button>
    <h2>Netzwerk w√§hlen</h2>
    <div class="selection-grid" id="networkGrid"></div>
  </div>
  
  <!-- Step 3: Search Station -->
  <div class="card hidden" id="stepSearch">
    <button class="back-btn" onclick="goBack('network')">‚Üê Zur√ºck</button>
    <h2>Station suchen</h2>
    <div class="search-container">
      <span class="search-icon">üîç</span>
      <input type="text" class="search-input" id="searchInput" placeholder="Stationsname eingeben..." autocomplete="off">
      <div class="search-spinner" id="searchSpinner"></div>
    </div>
    <div class="search-results" id="searchResults"></div>
  </div>
  
  <!-- Step 4: Select Lines -->
  <div class="card hidden" id="stepLines">
    <button class="back-btn" onclick="goBack('search')">‚Üê Zur√ºck</button>
    <h2 id="selectedStationName" style="color:#0055a4;">Linien ausw√§hlen</h2>
    <p style="color:#666;font-size:13px;margin-bottom:16px;" id="selectedStationInfo"></p>
    
    <div class="lines-loading" id="linesLoading">
      <div class="spinner"></div>
      <div>Lade Abfahrten...</div>
    </div>
    
    <div class="lines-container hidden" id="linesContainer">
      <div class="lines-header">
        <h3>Welche Linien anzeigen?</h3>
        <button class="select-all-btn" id="selectAllBtn" onclick="toggleSelectAll()">Alle ausw√§hlen</button>
      </div>
      <div id="linesList"></div>
    </div>
    
    <button class="btn btn-primary" id="addStationBtn" onclick="addStation()" disabled>
      Station hinzuf√ºgen
    </button>
  </div>
  
  <!-- Added Stations -->
  <div class="card">
    <h2>Deine Stationen (<span id="stationCount">0</span>)</h2>
    <div id="stationsContainer">
      <div class="empty-state" id="emptyState">
        <div class="icon">üöè</div>
        <p>Noch keine Stationen hinzugef√ºgt</p>
      </div>
    </div>
  </div>
</div>

<!-- Bottom Bar -->
<div class="bottom-bar">
  <div class="container">
    <button class="btn btn-save" id="saveBtn" onclick="saveConfig()" disabled>
      Speichern
    </button>
  </div>
</div>

<script>
// ==================== CONFIG ====================
const REGIONS = {
  AT: {
    name: '√ñsterreich',
    flag: 'üá¶üáπ',
    networks: ['WL', 'LINZ']
  },
  DE: {
    name: 'Deutschland', 
    flag: 'üá©üá™',
    networks: ['DB', 'BERLIN', 'BODO']
  },
  CH: {
    name: 'Schweiz',
    flag: 'üá®üá≠',
    networks: []
  },
  DK: {
    name: 'D√§nemark',
    flag: 'üá©üá∞',
    networks: []
  }
};

const NETWORKS = {
  WL: {
    name: 'Wiener Linien',
    region: 'AT',
    desc: 'U-Bahn, Stra√üenbahn, Bus',
    icon: 'üöá',
    searchType: 'wien_json',
    placeholder: 'z.B. Karlsplatz, Stephansplatz...'
  },
  LINZ: {
    name: 'Linz AG',
    region: 'AT', 
    desc: 'Stra√üenbahn, Bus',
    icon: 'üöä',
    searchType: 'server_proxy',
    placeholder: 'z.B. Hauptbahnhof, Taubenmarkt...'
  },
  DB: {
    name: 'Deutsche Bahn',
    region: 'DE',
    desc: 'ICE, IC, RE, RB, S-Bahn',
    icon: 'üöÑ',
    searchType: 'server_proxy',
    placeholder: 'z.B. Berlin Hbf, M√ºnchen...'
  },
  BERLIN: {
    name: 'VBB Berlin',
    region: 'DE',
    desc: 'U-Bahn, S-Bahn, Tram, Bus',
    icon: 'üöá',
    searchType: 'server_proxy',
    placeholder: 'z.B. Alexanderplatz...'
  },
  BODO: {
    name: 'BODO',
    region: 'DE',
    desc: 'Ulm, Bodensee Region',
    icon: 'üöå',
    searchType: 'server_proxy',
    placeholder: 'z.B. Ulm Hauptbahnhof...'
  }
};

const SEARCH_API = 'https://api.straba.at/api/v1/stops/search';
const DEPARTURES_API = 'https://api.straba.at/api/v1/wl/departures';
const WIEN_DATA_URL = 'https://straba-983965425140.europe-west3.run.app/search/';

// ==================== STATE ====================
let currentStep = 'region';
let selectedRegion = null;
let selectedNetwork = null;
let selectedStop = null;
let availableLines = [];
let selectedLines = new Set();
let stations = [];
let wienData = null;
let searchTimeout = null;

// ==================== DOM ====================
const stepRegion = document.getElementById('stepRegion');
const stepNetwork = document.getElementById('stepNetwork');
const stepSearch = document.getElementById('stepSearch');
const stepLines = document.getElementById('stepLines');
const networkGrid = document.getElementById('networkGrid');
const searchInput = document.getElementById('searchInput');
const searchSpinner = document.getElementById('searchSpinner');
const searchResults = document.getElementById('searchResults');
const linesLoading = document.getElementById('linesLoading');
const linesContainer = document.getElementById('linesContainer');
const linesList = document.getElementById('linesList');
const addStationBtn = document.getElementById('addStationBtn');
const stationsContainer = document.getElementById('stationsContainer');
const emptyState = document.getElementById('emptyState');
const stationCount = document.getElementById('stationCount');
const saveBtn = document.getElementById('saveBtn');
const breadcrumb = document.getElementById('breadcrumb');

// ==================== NAVIGATION ====================
function showStep(step) {
  currentStep = step;
  stepRegion.classList.toggle('hidden', step !== 'region');
  stepNetwork.classList.toggle('hidden', step !== 'network');
  stepSearch.classList.toggle('hidden', step !== 'search');
  stepLines.classList.toggle('hidden', step !== 'lines');
  updateBreadcrumb();
}

function updateBreadcrumb() {
  let html = '';
  
  html += `<span class="breadcrumb-item ${currentStep === 'region' ? 'active' : ''}" onclick="goBack('region')">Region</span>`;
  
  if (selectedRegion) {
    html += `<span class="breadcrumb-sep">‚Ä∫</span>`;
    html += `<span class="breadcrumb-item ${currentStep === 'network' ? 'active' : ''}" onclick="goBack('network')">${REGIONS[selectedRegion].flag} ${REGIONS[selectedRegion].name}</span>`;
  }
  
  if (selectedNetwork) {
    html += `<span class="breadcrumb-sep">‚Ä∫</span>`;
    html += `<span class="breadcrumb-item ${currentStep === 'search' ? 'active' : ''}" onclick="goBack('search')">${NETWORKS[selectedNetwork].name}</span>`;
  }
  
  if (selectedStop && currentStep === 'lines') {
    html += `<span class="breadcrumb-sep">‚Ä∫</span>`;
    html += `<span class="breadcrumb-item active">${selectedStop.name}</span>`;
  }
  
  breadcrumb.innerHTML = html;
}

function goBack(step) {
  if (step === 'region') {
    selectedRegion = null;
    selectedNetwork = null;
    selectedStop = null;
  } else if (step === 'network') {
    selectedNetwork = null;
    selectedStop = null;
  } else if (step === 'search') {
    selectedStop = null;
    searchInput.value = '';
    searchResults.classList.remove('show');
  }
  showStep(step);
}

// ==================== REGION SELECTION ====================
function selectRegion(region) {
  if (REGIONS[region].networks.length === 0) return;
  
  selectedRegion = region;
  renderNetworkGrid();
  showStep('network');
}

function renderNetworkGrid() {
  const networks = REGIONS[selectedRegion].networks;
  
  networkGrid.innerHTML = networks.map(id => {
    const net = NETWORKS[id];
    return `
      <button class="selection-btn" onclick="selectNetwork('${id}')">
        <div class="icon">${net.icon}</div>
        <div class="name">${net.name}</div>
        <div class="desc">${net.desc}</div>
      </button>
    `;
  }).join('');
}

// ==================== NETWORK SELECTION ====================
function selectNetwork(network) {
  selectedNetwork = network;
  searchInput.placeholder = NETWORKS[network].placeholder;
  searchInput.value = '';
  searchResults.classList.remove('show');
  
  if (network === 'WL' && !wienData) {
    loadWienData();
  }
  
  showStep('search');
  searchInput.focus();
}

// ==================== WIEN DATA ====================
async function loadWienData() {
  try {
    const response = await fetch(WIEN_DATA_URL);
    wienData = await response.json();
  } catch (e) {
    console.error('Failed to load Wien data:', e);
  }
}

// ==================== SEARCH ====================
searchInput.addEventListener('input', function() {
  const query = this.value.trim();
  if (searchTimeout) clearTimeout(searchTimeout);
  
  if (query.length < 2) {
    searchResults.classList.remove('show');
    return;
  }
  
  searchTimeout = setTimeout(() => performSearch(query), 300);
});

async function performSearch(query) {
  if (!selectedNetwork) return;
  
  searchSpinner.classList.add('show');
  
  try {
    let results = [];
    
    if (NETWORKS[selectedNetwork].searchType === 'wien_json') {
      results = searchWien(query);
    } else {
      results = await searchViaProxy(selectedNetwork, query);
    }
    
    displaySearchResults(results);
  } catch (e) {
    console.error('Search error:', e);
    searchResults.innerHTML = '<div class="no-results">Fehler bei der Suche</div>';
    searchResults.classList.add('show');
  } finally {
    searchSpinner.classList.remove('show');
  }
}

function searchWien(query) {
  if (!wienData) return [];
  
  const q = query.toLowerCase();
  const stationsMap = new Map();
  
  wienData.forEach(line => {
    if (!Array.isArray(line.lineStation)) return;
    line.lineStation.forEach(item => {
      const station = item.station;
      if (!station || !station.stationName || !station.stationID) return;
      if (station.stationName.toLowerCase().includes(q)) {
        const id = station.stationID;
        if (!stationsMap.has(id)) {
          stationsMap.set(id, { id: String(id), name: station.stationName, lines: new Set() });
        }
        stationsMap.get(id).lines.add(line.lineName);
      }
    });
  });
  
  return Array.from(stationsMap.values())
    .map(s => ({
      id: s.id,
      name: s.name,
      info: Array.from(s.lines).slice(0, 5).join(', ') + (s.lines.size > 5 ? '...' : '')
    }))
    .slice(0, 15);
}

async function searchViaProxy(network, query) {
  const params = new URLSearchParams({ network, q: query });
  const response = await fetch(`${SEARCH_API}?${params}`);
  const data = await response.json();
  return (data.stops || []).map(s => ({ id: s.id, name: s.name, info: s.info || '' }));
}

function displaySearchResults(results) {
  if (results.length === 0) {
    searchResults.innerHTML = '<div class="no-results">Keine Stationen gefunden</div>';
  } else {
    searchResults.innerHTML = results.map(r => `
      <div class="search-result-item" onclick="selectStop('${r.id}', '${r.name.replace(/'/g, "\\'")}')">
        <div class="stop-name">${r.name}</div>
        <div class="stop-info">${r.info || `ID: ${r.id}`}</div>
      </div>
    `).join('');
  }
  searchResults.classList.add('show');
}

// ==================== STOP SELECTION ====================
async function selectStop(id, name) {
  selectedStop = { id, name };
  selectedLines = new Set();
  availableLines = [];
  
  document.getElementById('selectedStationName').textContent = name;
  document.getElementById('selectedStationInfo').textContent = `${NETWORKS[selectedNetwork].name} ¬∑ ID: ${id}`;
  
  searchResults.classList.remove('show');
  showStep('lines');
  
  // Load departures to get available lines
  linesLoading.classList.remove('hidden');
  linesContainer.classList.add('hidden');
  addStationBtn.disabled = true;
  
  try {
    const fullId = `${selectedNetwork}:${id}`;
    const response = await fetch(`${DEPARTURES_API}?stopId=${fullId}`);
    const data = await response.json();
    
    extractLines(data);
    renderLines();
    
    linesLoading.classList.add('hidden');
    linesContainer.classList.remove('hidden');
  } catch (e) {
    console.error('Failed to load departures:', e);
    linesLoading.innerHTML = '<div style="color:#d32f2f">Fehler beim Laden der Linien</div>';
  }
}

function extractLines(data) {
  const linesMap = new Map();
  
  if (data.data && data.data.monitors) {
    data.data.monitors.forEach(monitor => {
      if (monitor.lines) {
        monitor.lines.forEach(line => {
          const name = line.name || '?';
          const towards = line.towards || '';
          const key = `${name}|${towards}`;
          
          if (!linesMap.has(key)) {
            linesMap.set(key, { name, towards, type: line.type || '' });
          }
        });
      }
    });
  }
  
  availableLines = Array.from(linesMap.values());
  
  // DEBUG: Zeige was von der API kommt
  console.log('Linien von API:', availableLines.map(l => ({ name: l.name, type: l.type })));
  
  availableLines.sort((a, b) => {
    const aNum = parseInt(a.name) || 999;
    const bNum = parseInt(b.name) || 999;
    if (aNum !== bNum) return aNum - bNum;
    return a.name.localeCompare(b.name);
  });
}

function renderLines() {
  if (availableLines.length === 0) {
    linesList.innerHTML = '<div class="no-results">Keine Abfahrten gefunden</div>';
    return;
  }
  
  // Group by line name
  const groups = new Map();
  availableLines.forEach((line, idx) => {
    if (!groups.has(line.name)) {
      groups.set(line.name, []);
    }
    groups.get(line.name).push({ ...line, idx });
  });
  
  let html = '';
  groups.forEach((directions, lineName) => {
    const allSelected = directions.every(d => selectedLines.has(d.idx));
    const someSelected = directions.some(d => selectedLines.has(d.idx));
    const lineType = directions[0]?.type || '';
    const badgeClass = getLineTypeClass(lineType, lineName);
    
    html += `
      <div class="line-group">
        <div class="line-group-header">
          <div class="line-badge ${badgeClass}">${lineName}</div>
          <div class="line-name">Linie ${lineName}</div>
          <button class="line-toggle" onclick="toggleLineGroup('${lineName}')">${allSelected ? 'Abw√§hlen' : 'Alle'}</button>
        </div>
        <div class="line-directions">
    `;
    
    directions.forEach(dir => {
      const selected = selectedLines.has(dir.idx);
      html += `
        <div class="direction-option ${selected ? 'selected' : ''}" onclick="toggleLine(${dir.idx})">
          <div class="checkbox">${selected ? '‚úì' : ''}</div>
          <div class="direction-text">${dir.towards || 'Alle Richtungen'}</div>
        </div>
      `;
    });
    
    html += `
        </div>
      </div>
    `;
  });
  
  linesList.innerHTML = html;
  updateAddButton();
  updateSelectAllButton();
}

function getLineTypeClass(type, lineName) {
  // Normalize type
  const t = (type || '').toLowerCase();
  
  // DEBUG
  console.log(`Line ${lineName}: type="${type}" -> normalized="${t}"`);
  
  // 1. Wenn API einen klaren Typ liefert, verwende diesen
  
  // Tram / Stra√üenbahn
  if (t.includes('tram') || t.includes('strassenbahn') || t === 'pttram' || t === 'pttramwlb') {
    return 'type-tram';
  }
  
  // U-Bahn / Metro
  if (t.includes('metro') || t.includes('ubahn') || t === 'ptmetro') {
    return 'type-metro';
  }
  
  // S-Bahn
  if (t.includes('suburban') || t === 'pttrains') {
    return 'type-suburban';
  }
  
  // Regional / Zug
  if (t.includes('train') || t.includes('regional') || t.includes('express') || 
      t === 'pttrain' || t === 'pttrainr') {
    return 'type-train';
  }
  
  // Bus explizit
  if (t.includes('bus') || t === 'ptbuscity' || t === 'ptbusnight') {
    return 'type-bus';
  }
  
  // 2. Wenn kein klarer Typ, rate basierend auf Linienname
  
  // U-Bahn: U1, U2, etc.
  if (/^U\d+$/.test(lineName)) {
    return 'type-metro';
  }
  
  // S-Bahn: S1, S2, S7, etc.
  if (/^S\d+$/.test(lineName)) {
    return 'type-suburban';
  }
  
  // Zug: RE, RB, IC, EC, ICE
  if (/^(RE|RB|IC|EC|ICE|IR|R)\d*$/.test(lineName)) {
    return 'type-train';
  }
  
  // Bus: Hat Buchstaben am Ende (7A, 26A, 29B, 35A) oder ist dreistellig+
  if (/^\d+[A-Z]$/.test(lineName) || /^\d{3,}$/.test(lineName)) {
    return 'type-bus';
  }
  
  // Niedrige Nummern (1-19) ohne Buchstaben = wahrscheinlich Tram
  // (In Wien, Linz, etc. sind das typischerweise Stra√üenbahnlinien)
  const num = parseInt(lineName);
  if (!isNaN(num) && num >= 1 && num <= 19 && /^\d+$/.test(lineName)) {
    return 'type-tram';
  }
  
  // Mittlere Nummern (20-99) ohne Buchstaben = wahrscheinlich Bus
  if (!isNaN(num) && num >= 20 && num <= 99 && /^\d+$/.test(lineName)) {
    return 'type-bus';
  }
  
  // Default
  return 'type-default';
}

function toggleLineGroup(lineName) {
  const directions = availableLines
    .map((line, idx) => ({ ...line, idx }))
    .filter(line => line.name === lineName);
  
  const allSelected = directions.every(d => selectedLines.has(d.idx));
  
  if (allSelected) {
    directions.forEach(d => selectedLines.delete(d.idx));
  } else {
    directions.forEach(d => selectedLines.add(d.idx));
  }
  
  renderLines();
}

function toggleLine(idx) {
  if (selectedLines.has(idx)) {
    selectedLines.delete(idx);
  } else {
    selectedLines.add(idx);
  }
  renderLines();
}

function toggleSelectAll() {
  if (selectedLines.size === availableLines.length) {
    selectedLines.clear();
  } else {
    availableLines.forEach((_, idx) => selectedLines.add(idx));
  }
  renderLines();
}

function updateSelectAllButton() {
  const btn = document.getElementById('selectAllBtn');
  btn.textContent = selectedLines.size === availableLines.length ? 'Alle abw√§hlen' : 'Alle ausw√§hlen';
}

function updateAddButton() {
  addStationBtn.disabled = selectedLines.size === 0;
}

// ==================== ADD STATION ====================
function addStation() {
  if (!selectedNetwork || !selectedStop || selectedLines.size === 0) return;
  
  const selectedLineNames = Array.from(selectedLines).map(idx => availableLines[idx].name);
  const uniqueLineNames = [...new Set(selectedLineNames)];
  const filter = uniqueLineNames.join(',');
  
  const fullId = `${selectedNetwork}:${selectedStop.id}`;
  
  // Check duplicate
  if (stations.some(s => s.fullId === fullId)) {
    alert('Diese Station ist bereits hinzugef√ºgt!');
    return;
  }
  
  stations.push({
    network: selectedNetwork,
    networkName: NETWORKS[selectedNetwork].name,
    stopId: selectedStop.id,
    stopName: selectedStop.name,
    filter: filter,
    fullId: fullId,
    isExisting: false
  });
  
  // Reset and go back
  selectedStop = null;
  selectedLines = new Set();
  goBack('region');
  updateStationsList();
}

function removeStation(idx) {
  stations.splice(idx, 1);
  updateStationsList();
}

function updateStationsList() {
  stationCount.textContent = stations.length;
  
  if (stations.length === 0) {
    emptyState.style.display = 'block';
    saveBtn.disabled = true;
  } else {
    emptyState.style.display = 'none';
    saveBtn.disabled = false;
  }
  
  const chips = stations.map((s, idx) => `
    <div class="station-chip ${s.isExisting ? 'existing' : ''}">
      <span class="network-badge">${s.network}</span>
      <div class="info">
        <div class="stop-name">${s.stopName}</div>
        <div class="stop-details">Linien: ${s.filter || 'Alle'}</div>
      </div>
      <button class="delete" onclick="removeStation(${idx})">‚úï</button>
    </div>
  `).join('');
  
  const existingChips = stationsContainer.querySelectorAll('.station-chip');
  existingChips.forEach(c => c.remove());
  emptyState.insertAdjacentHTML('beforebegin', chips);
}

// ==================== SAVE ====================
function saveConfig() {
  if (stations.length === 0) return;
  
  const rblString = stations.map(s => s.fullId).join(',');
  const filterString = stations.map(s => s.filter || '').join('|');
  
  console.log('Saving:', { rbl: rblString, filter: filterString });
  
  localStorage.setItem('straba_pending_rbl', rblString);
  localStorage.setItem('straba_pending_filter', filterString);
  
  // Send to parent (ESP32)
  if (window.parent && window.parent !== window) {
    window.parent.postMessage({ type: 'setConfig', rbl: rblString, filter: filterString }, '*');
  }
  
  window.location.href = 'index.html';
}

// ==================== LOAD EXISTING ====================
function loadExistingConfig(rbl, filter) {
  if (!rbl || rbl.trim() === '') return;
  
  const rblParts = rbl.split(',').map(s => s.trim()).filter(s => s);
  const filterParts = filter ? filter.split('|') : [];
  
  rblParts.forEach((part, idx) => {
    let network, stopId;
    if (part.includes(':')) {
      [network, stopId] = part.split(':');
    } else {
      network = 'WL';
      stopId = part;
    }
    
    const fullId = `${network}:${stopId}`;
    if (stations.some(s => s.fullId === fullId)) return;
    
    stations.push({
      network,
      networkName: NETWORKS[network]?.name || network,
      stopId,
      stopName: `Station ${stopId}`,
      filter: filterParts[idx] || '',
      fullId,
      isExisting: true
    });
  });
  
  if (stations.length > 0) {
    updateStationsList();
  }
}

// ==================== ESP32 COMMUNICATION ====================
window.addEventListener('message', function(event) {
  if (event.data?.type === 'loadExistingConfig') {
    loadExistingConfig(event.data.rbl, event.data.filter);
  }
  if (event.data?.type === 'loadFullConfig' && event.data.config?.rbl_id) {
    loadExistingConfig(event.data.config.rbl_id, event.data.config.lines_filter);
  }
});

// ==================== INIT ====================
window.addEventListener('DOMContentLoaded', () => {
  if (window.parent && window.parent !== window) {
    window.parent.postMessage({ type: 'requestExistingConfig' }, '*');
    window.parent.postMessage({ type: 'requestFullConfig' }, '*');
  }
  
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
      searchResults.classList.remove('show');
    }
  });
});
</script>

</body>
</html>
