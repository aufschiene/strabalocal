<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Straba - Erweiterte Features</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(135deg,#1a1a2e,#16213e);min-height:100vh;padding:20px;color:#fff}
    .container{max-width:440px;margin:0 auto}
    
    .logo{display:block;max-width:200px;height:auto;margin:0 auto 12px auto}
    .subtitle{text-align:center;color:#aaa;margin-bottom:16px;font-size:14px;text-transform:uppercase;letter-spacing:1px}
    
    /* Intro Box */
    .intro-box{
      text-align:center;
      padding:16px 20px;
      margin-bottom:24px;
      font-size:15px;
      color:#ccc;
      line-height:1.5;
    }
    .intro-box a{
      color:#ffd700;
      text-decoration:none;
      font-weight:600;
    }
    .intro-box a:hover{
      text-decoration:underline;
    }
    .back-link{
      display:inline-block;
      margin-top:12px;
      padding:10px 20px;
      background:rgba(255,255,255,0.1);
      border-radius:10px;
      color:#fff !important;
      font-weight:500;
      transition:all 0.2s;
    }
    .back-link:hover{
      background:rgba(255,255,255,0.2);
      text-decoration:none !important;
    }
    
    /* Cards */
    .card{background:rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:16px;border:1px solid rgba(255,255,255,0.1)}
    .card h2{font-size:14px;margin-bottom:16px;color:#ffd700;text-transform:uppercase;letter-spacing:0.5px;display:flex;align-items:center;gap:8px}
    
    /* Control Rows */
    .control-row{display:flex;justify-content:space-between;align-items:center;padding:14px 0;border-bottom:1px solid rgba(255,255,255,0.08)}
    .control-row:last-child{border-bottom:none}
    .control-label{flex:1}
    .control-label span{display:block;font-size:15px;font-weight:500}
    .control-label small{color:#888;font-size:12px;margin-top:3px;display:block;line-height:1.4}
    
    /* Segmented Control */
    .segmented{display:flex;background:rgba(0,0,0,0.3);border-radius:10px;padding:3px;gap:3px}
    .seg-btn{
      flex:1;
      padding:10px 14px;
      font-size:13px;
      font-weight:600;
      border-radius:8px;
      color:#888;
      cursor:pointer;
      text-align:center;
      transition:all 0.2s;
      border:none;
      background:none;
      white-space:nowrap;
    }
    .seg-btn:hover{color:#ccc}
    .seg-btn.active{background:#ffd700;color:#1a1a2e}
    
    /* Segmented mit Label darunter */
    .seg-btn-with-label{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:10px 14px;
      font-size:13px;
      font-weight:600;
      border-radius:8px;
      color:#888;
      cursor:pointer;
      text-align:center;
      transition:all 0.2s;
      border:none;
      background:none;
      gap:2px;
    }
    .seg-btn-with-label:hover{color:#ccc}
    .seg-btn-with-label.active{background:#ffd700;color:#1a1a2e}
    .seg-btn-with-label .badge{
      font-size:9px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.3px;
      opacity:0.7;
    }
    .seg-btn-with-label.active .badge{opacity:1}
    
    /* Breitere Segmented f√ºr Zeilen */
    .segmented.wide{min-width:180px}
    .segmented.wide .seg-btn{padding:12px 20px;font-size:15px}
    
    /* Toggle */
    .toggle{
      width:52px;
      height:32px;
      background:rgba(255,255,255,0.15);
      border-radius:32px;
      position:relative;
      cursor:pointer;
      transition:background 0.3s;
      flex-shrink:0;
    }
    .toggle.on{background:#ffd700}
    .toggle::after{
      content:"";
      position:absolute;
      top:3px;
      left:3px;
      width:26px;
      height:26px;
      background:#fff;
      border-radius:50%;
      transition:transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:0 2px 4px rgba(0,0,0,0.2);
    }
    .toggle.on::after{transform:translateX(20px)}
    
    /* Color Picker */
    .color-row{display:flex;gap:12px}
    .color-dot{
      width:38px;
      height:38px;
      border-radius:50%;
      cursor:pointer;
      border:3px solid transparent;
      transition:all 0.2s;
    }
    .color-dot:hover{transform:scale(1.1)}
    .color-dot.active{border-color:#fff;box-shadow:0 0 12px rgba(255,255,255,0.3)}
    .color-amber{background:#ffb340}
    .color-white{background:#ffffff}
    .color-orange{background:#ff9500}
    
    /* Expandable Card - Eine zusammenh√§ngende Bubble */
    .expand-card{
      background:rgba(255,255,255,0.08);
      border-radius:16px;
      margin-bottom:16px;
      border:1px solid rgba(255,255,255,0.1);
      overflow:hidden;
    }
    .expand-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:18px 20px;
      cursor:pointer;
      transition:background 0.2s;
    }
    .expand-header:hover{background:rgba(255,255,255,0.03)}
    .expand-header h2{
      margin:0;
      font-size:14px;
      color:#ffd700;
      text-transform:uppercase;
      letter-spacing:0.5px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .expand-arrow{
      font-size:18px;
      color:#888;
      transition:transform 0.3s;
    }
    .expand-header.open .expand-arrow{transform:rotate(180deg);color:#ffd700}
    
    .expand-content{
      max-height:0;
      overflow:hidden;
      transition:max-height 0.4s ease-out;
    }
    .expand-content.open{max-height:2000px}
    
    .expand-inner{
      padding:0 20px 20px 20px;
      border-top:1px solid rgba(255,255,255,0.08);
    }
    
    /* Sections innerhalb der erweiterten Einstellungen */
    .inner-section{
      padding-top:20px;
    }
    .inner-section:not(:last-child){
      padding-bottom:20px;
      border-bottom:1px solid rgba(255,255,255,0.08);
    }
    .inner-section h3{
      font-size:13px;
      color:#ffd700;
      margin-bottom:14px;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:8px;
    }
    
    /* Feature Description */
    .feature-desc{
      font-size:13px;
      color:#aaa;
      line-height:1.6;
      margin-bottom:16px;
      padding:12px 14px;
      background:rgba(0,0,0,0.15);
      border-radius:10px;
    }
    
    /* Subsections */
    .sub-section{
      background:rgba(0,0,0,0.2);
      border-radius:12px;
      padding:16px;
      margin-top:14px;
      transition:opacity 0.3s, transform 0.3s;
    }
    .sub-section.disabled{opacity:0.4;pointer-events:none;transform:scale(0.98)}
    .sub-section h4{font-size:12px;color:#aaa;margin-bottom:12px;font-weight:500;text-transform:uppercase;letter-spacing:0.3px}
    
    /* Gehweg Liste */
    .gehweg-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 0;
      border-bottom:1px solid rgba(255,255,255,0.06);
      gap:12px;
    }
    .gehweg-item:last-child{border-bottom:none}
    .gehweg-item .stop-info{flex:1;min-width:0}
    .gehweg-item .stop-name{font-size:14px;color:#fff;font-weight:600;margin-bottom:4px}
    .gehweg-item .stop-id{font-size:12px;color:#888;margin-top:2px}
    .gehweg-item .stop-lines{font-size:12px;color:#aaa;line-height:1.6}
    .line-badge-small{
      display:inline-block;
      background:rgba(255,215,0,0.2);
      color:#ffd700;
      padding:2px 6px;
      border-radius:4px;
      font-weight:600;
      font-size:11px;
      margin-right:4px;
    }
    .gehweg-item input{
      width:70px;
      text-align:center;
      padding:10px;
      background:rgba(0,0,0,0.3);
      border:2px solid rgba(255,255,255,0.15);
      color:#fff;
      border-radius:10px;
      font-size:15px;
      flex-shrink:0;
    }
    .gehweg-item input:focus{outline:none;border-color:#ffd700}
    .gehweg-item input:invalid{border-color:#ff453a}
    .gehweg-error{font-size:11px;color:#ff453a;margin-top:4px;display:none}
    .gehweg-error.show{display:block}
    .gehweg-item .unit{color:#888;font-size:13px;margin-left:8px;flex-shrink:0}
    
    /* Number inputs */
    input[type="number"]{
      width:80px;
      text-align:center;
      background:rgba(0,0,0,0.3);
      border:2px solid rgba(255,255,255,0.15);
      color:#fff;
      border-radius:10px;
      padding:10px;
      font-size:15px;
    }
    input[type="number"]:focus{outline:none;border-color:#ffd700}
    
    /* Hints */
    .hint-small{
      font-size:12px;
      color:#888;
      margin-top:10px;
      line-height:1.4;
    }
    
    /* Preview Box */
    .preview-box{
      background:#000;
      border-radius:8px;
      padding:16px;
      font-family:"SF Mono",Monaco,"Courier New",monospace;
      border:2px solid #333;
      margin-bottom:12px;
    }
    .preview-row{
      display:flex;
      justify-content:space-between;
      padding:8px 0;
      font-size:15px;
      letter-spacing:0.5px;
    }
    .preview-row .line-num{font-weight:bold;min-width:36px}
    .preview-row .destination{flex:1;margin-left:8px}
    .preview-row .countdown{font-weight:bold}
    
    /* Buttons */
    .btn-primary{
      width:100%;
      padding:16px;
      background:#ffd700;
      color:#1a1a2e;
      border-radius:12px;
      font-weight:700;
      font-size:16px;
      border:none;
      cursor:pointer;
      margin-top:20px;
      margin-bottom:40px;
      transition:all 0.2s;
    }
    .btn-primary:hover{background:#ffed4a;transform:translateY(-2px);box-shadow:0 4px 20px rgba(255,215,0,0.3)}
    .btn-primary:active{transform:translateY(0)}
    
    /* Loading Overlay */
    .loading{
      position:fixed;
      top:0;left:0;right:0;bottom:0;
      background:rgba(0,0,0,0.92);
      display:none;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:20px;
      z-index:1000;
    }
    .loading.show{display:flex}
    .spinner{
      width:48px;height:48px;
      border:3px solid #333;
      border-top-color:#ffd700;
      border-radius:50%;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{font-size:16px;color:#fff}
    
    /* Pending Stations Banner */
    .pending-banner{
      background:linear-gradient(135deg,rgba(56,239,125,0.2),rgba(17,153,142,0.2));
      border:1px solid rgba(56,239,125,0.4);
      border-radius:12px;
      padding:14px 16px;
      margin-bottom:16px;
    }
    .pending-title{
      font-weight:600;
      color:#38ef7d;
      margin-bottom:4px;
      font-size:14px;
    }
    .pending-text{
      color:#aaa;
      font-size:12px;
    }
  </style>
</head>
<body>
<div class="container">
  <img src="straba.png" alt="Straba" class="logo">
  <p class="subtitle">Erweiterte Features</p>
  
  <!-- ==================== INTRO ==================== -->
  <div class="intro-box">
    Nun kannst du dein Straba ganz nach deinen W√ºnschen einstellen.<br>
    <a href="localmainpage.html" class="back-link">‚Üê Zur√ºck zu Linien einstellen</a>
  </div>
  
  <!-- Banner f√ºr neue Stationen -->
  <div class="pending-banner" id="pendingBanner" style="display:none;">
    <div class="pending-title">‚úì Neue Stationen bereit</div>
    <div class="pending-text" id="pendingText">Deine ausgew√§hlten Stationen werden beim Speichern √ºbernommen.</div>
  </div>
  
  <!-- ==================== VORSCHAU ==================== -->
  <div class="card">
    <h2>üì∫ Vorschau <span style="font-weight:400;font-size:12px;color:#888;text-transform:none;letter-spacing:0">‚Äì Beispiel Linien</span></h2>
    <div class="preview-box" id="preview">
      <!-- Wird dynamisch generiert -->
    </div>
  </div>
  
  <!-- ==================== ANZEIGE ==================== -->
  <div class="card">
    <h2>üìä Anzeige</h2>
    
    <div class="control-row">
      <div class="control-label"><span>Anzahl Zeilen</span></div>
      <div class="segmented wide" data-name="anzeige">
        <div class="seg-btn" data-value="1">1</div>
        <div class="seg-btn active" data-value="2">2</div>
        <div class="seg-btn" data-value="3">3</div>
      </div>
    </div>
    
    <div class="control-row">
      <div class="control-label">
        <span>Sortierung</span>
        <small id="sortmodeHint">Statisch = Feste Reihenfolge der Linien</small>
      </div>
      <div class="segmented" data-name="sortmode">
        <div class="seg-btn active" data-value="1">Statisch</div>
        <div class="seg-btn" data-value="2">Nach Zeit</div>
      </div>
    </div>
  </div>
  
  <!-- ==================== BARRIEREFREIHEIT ==================== -->
  <div class="card">
    <h2>‚ôø Barrierefreiheit</h2>
    
    <div class="control-row">
      <div class="control-label">
        <span>Hochflurer markieren</span>
      </div>
      <div class="segmented" data-name="chopper">
        <div class="seg-btn" data-value="0">Aus</div>
        <div class="seg-btn active" data-value="1">An</div>
      </div>
    </div>
    
    <div class="control-row">
      <div class="control-label">
        <span>U-Bahnen mit Klimaanlage</span>
      </div>
      <div class="segmented" data-name="silberpfeil">
        <div class="seg-btn" data-value="0">Aus</div>
        <div class="seg-btn active" data-value="1">An</div>
      </div>
    </div>
  </div>
  
  <!-- ==================== DESIGN ==================== -->
  <div class="card">
    <h2>üé® Design</h2>
    
    <div class="control-row">
      <div class="control-label"><span>Textfarbe</span></div>
      <div class="color-row" data-name="colour">
        <div class="color-dot color-amber active" data-value="1" title="Gelb/Amber"></div>
        <div class="color-dot color-white" data-value="2" title="Wei√ü"></div>
        <div class="color-dot color-orange" data-value="3" title="Orange"></div>
      </div>
    </div>
    
    <div class="control-row">
      <div class="control-label"><span>Helligkeit</span></div>
      <div class="segmented" data-name="displaylight">
        <div class="seg-btn" data-value="1">Dunkel</div>
        <div class="seg-btn" data-value="2">Mittel</div>
        <div class="seg-btn active" data-value="3">Hell</div>
      </div>
    </div>
  </div>
  
  <!-- ==================== NACHTMODUS ==================== -->
  <div class="card">
    <h2>üåô Nachtmodus</h2>
    
    <div class="control-row">
      <div class="control-label">
        <span>Nachtmodus aktivieren</span>
        <small>Display schaltet sich automatisch ab</small>
      </div>
      <div class="toggle" id="nightmodeToggle"></div>
    </div>
    
    <div class="sub-section disabled" id="nightSettings">
      <div class="control-row">
        <div class="control-label"><span>Display aus ab</span></div>
        <input type="number" id="nightstart" min="0" max="23" value="22">
        <span style="color:#888;margin-left:8px">Uhr</span>
      </div>
      <div class="control-row">
        <div class="control-label"><span>Display an ab</span></div>
        <input type="number" id="nightend" min="0" max="23" value="7">
        <span style="color:#888;margin-left:8px">Uhr</span>
      </div>
    </div>
    
    <div class="hint-small">
      Im Nachtmodus schaltet sich das Display komplett ab.
    </div>
  </div>
  
  <!-- ==================== ERWEITERTE EINSTELLUNGEN (Eine Bubble) ==================== -->
  <div class="expand-card">
    <div class="expand-header" id="expandHeader" onclick="toggleExpand()">
      <h2>‚öôÔ∏è Erweiterte Einstellungen</h2>
      <span class="expand-arrow">‚ñº</span>
    </div>
    
    <div class="expand-content" id="expandContent">
      <div class="expand-inner">
        
        <!-- ANZEIGE-MODUS -->
        <div class="inner-section">
          <h3>üîÑ Anzeige-Modus</h3>
          
          <div class="feature-desc">
            Straba nimmt alle Stationen und mischt sie auf ein geordnetes Display, sodass du auf einer Anzeige alle deine Verbindungen gleichzeitig im Blick hast. Falls du das nicht willst, w√§hle ‚ÄûSlideshow" ‚Äì hier wird jede Haltestelle einzeln angezeigt.
          </div>
          
          <div class="control-row">
            <div class="control-label">
              <span>Modus</span>
            </div>
            <div class="segmented" data-name="displaymode">
              <div class="seg-btn-with-label active" data-value="1">
                <span>Gemischt</span>
                <span class="badge">Empfohlen</span>
              </div>
              <div class="seg-btn-with-label" data-value="2">
                <span>Slideshow</span>
                <span class="badge">&nbsp;</span>
              </div>
            </div>
          </div>
          
          <div class="sub-section disabled" id="slideshowSettings">
            <h4>Slideshow-Einstellungen</h4>
            <div class="control-row">
              <div class="control-label">
                <span>Wechsel-Intervall</span>
              </div>
              <div class="segmented" data-name="stopinterval" style="width:200px">
                <div class="seg-btn" data-value="5">5s</div>
                <div class="seg-btn active" data-value="10">10s</div>
                <div class="seg-btn" data-value="15">15s</div>
                <div class="seg-btn" data-value="30">30s</div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- GEHWEG -->
        <div class="inner-section">
          <h3>üö∂ Gehweg zur Haltestelle</h3>
          
          <div class="control-row">
            <div class="control-label">
              <span>Gehweg-Filter aktivieren</span>
              <small>Blendet unerreichbare Abfahrten aus.<br>Die Gehzeit kann bis zu 15 Minuten eingestellt werden.</small>
            </div>
            <div class="toggle" id="gehwegToggle"></div>
          </div>
          
          <div class="sub-section disabled" id="gehwegSettings">
            <h4>Gehzeit pro Haltestelle</h4>
            <div id="gehwegList">
              <div class="gehweg-item">
                <div class="stop-info">
                  <div class="stop-name" style="color:#888">Lade Haltestellen...</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="hint-small">
            Abfahrten unter der Minutenzahl werden ausgeblendet. 0 = kein Filter.
          </div>
        </div>
        
      </div>
    </div>
  </div>
  
  <!-- ==================== SPEICHERN ==================== -->
  <button class="btn-primary" id="saveBtn">üíæ Speichern & Neustarten</button>
  
</div>

<!-- ==================== LOADING OVERLAY ==================== -->
<div class="loading" id="loading">
  <div class="spinner"></div>
  <div class="loading-text">Speichere & starte neu...</div>
</div>

<script>
// ==================== EXPAND TOGGLE ====================
function toggleExpand() {
  const header = document.getElementById('expandHeader');
  const content = document.getElementById('expandContent');
  header.classList.toggle('open');
  content.classList.toggle('open');
}

// ==================== SEGMENTED CONTROLS ====================
document.querySelectorAll('.segmented').forEach(seg => {
  seg.querySelectorAll('.seg-btn, .seg-btn-with-label').forEach(btn => {
    btn.addEventListener('click', () => {
      seg.querySelectorAll('.seg-btn, .seg-btn-with-label').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      updateUI();
    });
  });
});

// ==================== COLOR DOTS ====================
document.querySelectorAll('.color-row').forEach(row => {
  row.querySelectorAll('.color-dot').forEach(dot => {
    dot.addEventListener('click', () => {
      row.querySelectorAll('.color-dot').forEach(d => d.classList.remove('active'));
      dot.classList.add('active');
      updatePreview();
    });
  });
});

// ==================== TOGGLES ====================
document.querySelectorAll('.toggle').forEach(toggle => {
  toggle.addEventListener('click', () => {
    toggle.classList.toggle('on');
    updateUI();
  });
});

// ==================== GEHWEG LISTE ====================
let currentStopIds = [];
let currentStationDetails = [];

function updateGehwegList(stopIds, gehwegValues, stationDetails) {
  const container = document.getElementById('gehwegList');
  currentStopIds = stopIds || [];
  currentStationDetails = stationDetails || [];
  
  // Pr√ºfe ob pending Details aus localStorage vorhanden
  if (currentStationDetails.length === 0) {
    const pendingDetails = localStorage.getItem('straba_pending_details');
    if (pendingDetails) {
      try {
        currentStationDetails = JSON.parse(pendingDetails);
      } catch (e) {
        console.error('Fehler beim Parsen der Station Details:', e);
      }
    }
  }
  
  if (currentStopIds.length === 0 && currentStationDetails.length === 0) {
    container.innerHTML = `
      <div class="gehweg-item">
        <div class="stop-info">
          <div class="stop-name" style="color:#888">Keine Haltestellen konfiguriert</div>
          <div class="stop-id" style="color:#666">Bitte zuerst Linien einstellen</div>
        </div>
      </div>
    `;
    return;
  }
  
  const values = gehwegValues || [];
  
  // Wenn wir Details haben, zeige diese an
  if (currentStationDetails.length > 0) {
    container.innerHTML = currentStationDetails.map((station, i) => {
      const val = values[i] !== undefined ? values[i] : 0;
      const linesDisplay = station.lines.map(l => 
        `<span class="line-badge-small">${l.name}</span> ‚Üí ${l.direction}`
      ).join('<br>');
      
      return `
        <div class="gehweg-item">
          <div class="stop-info">
            <div class="stop-name">${station.name}</div>
            <div class="stop-lines">${linesDisplay}</div>
          </div>
          <input type="number" min="0" max="15" step="1" value="${val}" data-index="${i}" onchange="validateGehweg(this)" oninput="validateGehweg(this)">
          <span class="unit">Min</span>
        </div>
      `;
    }).join('');
  } else {
    // Fallback: Nur Stop-IDs anzeigen
    container.innerHTML = currentStopIds.map((id, i) => {
      const val = values[i] !== undefined ? values[i] : 0;
      return `
        <div class="gehweg-item">
          <div class="stop-info">
            <div class="stop-name">Haltestelle ${i + 1}</div>
            <div class="stop-id">RBL ${id}</div>
          </div>
          <input type="number" min="0" max="15" step="1" value="${val}" data-index="${i}" onchange="validateGehweg(this)" oninput="validateGehweg(this)">
          <span class="unit">Min</span>
        </div>
      `;
    }).join('');
  }
}

function getCurrentGehwegValues() {
  const inputs = document.querySelectorAll('#gehwegList input[type="number"]');
  return Array.from(inputs).map(inp => parseInt(inp.value) || 0);
}

function validateGehweg(input) {
  let val = parseFloat(input.value);
  
  // Keine Kommazahlen - nur ganze Zahlen
  if (!Number.isInteger(val)) {
    val = Math.floor(val);
  }
  
  // Begrenzen auf 0-15
  if (val < 0) val = 0;
  if (val > 15) val = 15;
  
  // Wert setzen
  input.value = val;
}

function getGehwegString() {
  const values = getCurrentGehwegValues();
  if (values.length === 0) return '0';
  return values.join('|');
}

// ==================== UI UPDATES ====================
function updateUI() {
  // Slideshow Settings
  const displayMode = getSegmentValue('displaymode');
  const slideshowSettings = document.getElementById('slideshowSettings');
  slideshowSettings.classList.toggle('disabled', displayMode !== '2');
  
  // Gehweg Settings
  const gehwegOn = document.getElementById('gehwegToggle').classList.contains('on');
  document.getElementById('gehwegSettings').classList.toggle('disabled', !gehwegOn);
  
  // Night Settings
  const nightOn = document.getElementById('nightmodeToggle').classList.contains('on');
  document.getElementById('nightSettings').classList.toggle('disabled', !nightOn);
  
  // Sortmode Hint
  const sortMode = getSegmentValue('sortmode');
  const sortHint = document.getElementById('sortmodeHint');
  if (sortHint) {
    sortHint.textContent = sortMode === '1' 
      ? 'Statisch = Feste Reihenfolge der Linien' 
      : 'Zeit = N√§chste Abfahrt immer oben';
  }
  
  updatePreview();
}

function updatePreview() {
  const colourVal = getSegmentValue('colour');
  const colors = {
    '1': '#ffb340',
    '2': '#ffffff',
    '3': '#ff9500'
  };
  const textColor = colors[colourVal] || '#ffb340';
  
  // Helligkeit
  const brightness = getSegmentValue('displaylight');
  const opacityMap = { '1': 0.4, '2': 0.7, '3': 1.0 };
  const brightnessOpacity = opacityMap[brightness] || 1.0;
  
  const zeilenCount = parseInt(getSegmentValue('anzeige')) || 2;
  const sortMode = getSegmentValue('sortmode');
  const hochflurerOn = getSegmentValue('chopper') === '1';
  const klimaanlageOn = getSegmentValue('silberpfeil') === '1';
  
  // Nachtmodus Check
  const nightOn = document.getElementById('nightmodeToggle').classList.contains('on');
  const nightStart = parseInt(document.getElementById('nightstart').value) || 22;
  const nightEnd = parseInt(document.getElementById('nightend').value) || 7;
  const currentHour = new Date().getHours();
  
  const preview = document.getElementById('preview');
  
  // Nachtmodus aktiv?
  let isNightTime = false;
  if (nightOn) {
    if (nightStart > nightEnd) {
      isNightTime = currentHour >= nightStart || currentHour < nightEnd;
    } else {
      isNightTime = currentHour >= nightStart && currentHour < nightEnd;
    }
  }
  
  if (isNightTime) {
    preview.innerHTML = '<div style="text-align:center;color:#444;padding:20px;font-size:13px;">üí§ Display ist im Nachtmodus aus</div>';
    preview.style.opacity = '0.5';
    return;
  }
  
  preview.style.opacity = brightnessOpacity;
  
  // Beispiel-Linien Daten
  let lines = [
    { line: 'U6', dest: 'Floridsdorf', time: 4, isHochflurer: false, hasKlima: true },
    { line: '2', dest: 'Dornbach', time: 6, isHochflurer: true, hasKlima: false },
    { line: '13A', dest: 'Hauptbahnhof', time: 8, isHochflurer: false, hasKlima: false }
  ];
  
  // Sortierung
  if (sortMode === '1') {
    // Statisch: 13A, U6, 2
    lines = [lines[2], lines[0], lines[1]];
  } else {
    // Zeit: Nach Countdown sortiert
    lines.sort((a, b) => a.time - b.time);
  }
  
  // Nur gew√ºnschte Anzahl Zeilen
  lines = lines.slice(0, zeilenCount);
  
  // HTML generieren
  preview.innerHTML = lines.map(l => {
    let lineDisplay = l.line;
    let rowColor = textColor;
    
    // Klimaanlage: * bei U-Bahnen
    if (klimaanlageOn && l.hasKlima) {
      lineDisplay = l.line + '*';
    }
    
    // Hochflurer: Blaue Schrift
    if (hochflurerOn && l.isHochflurer) {
      rowColor = '#87ceeb';
    }
    
    return `
      <div class="preview-row" style="color:${rowColor}">
        <span class="line-num">${lineDisplay}</span>
        <span class="destination">${l.dest}</span>
        <span class="countdown">${l.time}</span>
      </div>
    `;
  }).join('');
}

function getSegmentValue(name) {
  const seg = document.querySelector(`[data-name="${name}"]`);
  if (!seg) return '1';
  const active = seg.querySelector('.active');
  return active ? active.dataset.value : '1';
}

function setSegmentValue(name, value) {
  const seg = document.querySelector(`[data-name="${name}"]`);
  if (!seg) return;
  seg.querySelectorAll('.seg-btn, .seg-btn-with-label, .color-dot').forEach(btn => {
    btn.classList.remove('active');
    if (btn.dataset.value === String(value)) {
      btn.classList.add('active');
    }
  });
}

// ==================== CONFIG LADEN ====================
async function loadConfig() {
  try {
    const resp = await fetch('/debug');
    const text = await resp.text();
    const config = JSON.parse(text);
    
    console.log('Config geladen:', config);
    
    // Anzeige
    setSegmentValue('anzeige', config.lines_count || '2');
    setSegmentValue('sortmode', config.sort_mode || '1');
    
    // Barrierefreiheit
    setSegmentValue('chopper', config.chopper || '1');
    setSegmentValue('silberpfeil', config.silberpfeil || '1');
    
    // Design
    setSegmentValue('colour', config.colour || '1');
    setSegmentValue('displaylight', config.displaylight || '3');
    
    // Nachtmodus
    if (config.night_mode_enabled) {
      document.getElementById('nightmodeToggle').classList.add('on');
    }
    document.getElementById('nightstart').value = config.night_mode_start || '22';
    document.getElementById('nightend').value = config.night_mode_end || '7';
    
    // Erweiterte Einstellungen
    setSegmentValue('displaymode', config.display_mode || '1');
    setSegmentValue('stopinterval', config.stop_interval || '10');
    
    // Gehweg
    const stopIds = (config.rbl_id || '').split(',').map(s => s.trim()).filter(s => s);
    const gehwegValues = (config.gehweg || '0').split('|').map(v => parseInt(v) || 0);
    updateGehwegList(stopIds, gehwegValues);
    
    if (config.gehweg && config.gehweg !== '0' && config.gehweg !== '') {
      const hasValue = gehwegValues.some(v => v > 0);
      if (hasValue) {
        document.getElementById('gehwegToggle').classList.add('on');
      }
    }
    
    updateUI();
    
  } catch (e) {
    console.error('Config laden fehlgeschlagen:', e);
    updateGehwegList([], []);
    updateUI();
  }
}

// ==================== SPEICHERN ====================
document.getElementById('saveBtn').addEventListener('click', async () => {
  document.getElementById('loading').classList.add('show');
  
  const formData = new FormData();
  
  // Stop-IDs von localmainpage (falls vorhanden)
  const pendingRbl = localStorage.getItem('straba_pending_rbl');
  const pendingFilter = localStorage.getItem('straba_pending_filter');
  
  if (pendingRbl) {
    formData.append('rbl', pendingRbl);
    formData.append('filter', pendingFilter || '');
    // Nach dem Senden l√∂schen
    localStorage.removeItem('straba_pending_rbl');
    localStorage.removeItem('straba_pending_filter');
    localStorage.removeItem('straba_pending_details');
  }
  
  // Anzeige
  formData.append('anzeige', getSegmentValue('anzeige'));
  formData.append('sortmode', getSegmentValue('sortmode'));
  
  // Barrierefreiheit
  formData.append('chopper', getSegmentValue('chopper'));
  formData.append('silberpfeil', getSegmentValue('silberpfeil'));
  
  // Design
  formData.append('colour', getSegmentValue('colour'));
  formData.append('displaylight', getSegmentValue('displaylight'));
  
  // Nachtmodus
  const nightOn = document.getElementById('nightmodeToggle').classList.contains('on');
  formData.append('nightmode', nightOn ? '1' : '0');
  formData.append('nightstart', document.getElementById('nightstart').value);
  formData.append('nightend', document.getElementById('nightend').value);
  
  // Erweiterte: Anzeige-Modus
  formData.append('displaymode', getSegmentValue('displaymode'));
  formData.append('stopinterval', getSegmentValue('stopinterval'));
  
  // Erweiterte: Gehweg
  const gehwegOn = document.getElementById('gehwegToggle').classList.contains('on');
  formData.append('gehweg', gehwegOn ? getGehwegString() : '0');
  
  console.log('Speichere Einstellungen...');
  
  try {
    await fetch('/config', { method: 'POST', body: formData });
  } catch (e) {
    // Verbindung bricht ab wegen Neustart
  }
  
  setTimeout(() => {
    document.querySelector('.loading-text').textContent = 'Neustart l√§uft...';
  }, 2000);
  
  setTimeout(() => {
    document.querySelector('.loading-text').textContent = 'Seite wird neu geladen...';
    location.reload();
  }, 6000);
});

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', () => {
  loadConfig();
  updatePreview();
  
  // Pr√ºfe ob neue Stationen von localmainpage √ºbertragen wurden
  const pendingRbl = localStorage.getItem('straba_pending_rbl');
  const pendingDetails = localStorage.getItem('straba_pending_details');
  
  if (pendingRbl) {
    const stopIds = pendingRbl.split(',').map(s => s.trim()).filter(s => s);
    let details = [];
    
    if (pendingDetails) {
      try {
        details = JSON.parse(pendingDetails);
      } catch (e) {
        console.error('Fehler beim Parsen der Station Details:', e);
      }
    }
    
    // Zeige Banner
    document.getElementById('pendingBanner').style.display = 'block';
    document.getElementById('pendingText').textContent = 
      `${stopIds.length} Station${stopIds.length > 1 ? 'en' : ''} ausgew√§hlt. Wird beim Speichern √ºbernommen.`;
    
    // Aktualisiere Gehweg-Liste mit pending Daten
    updateGehwegList(stopIds, [], details);
  }
});
</script>
</body>
</html>
